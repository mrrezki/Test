(self.webpackChunk_krassowski_jupyterlab_lsp=self.webpackChunk_krassowski_jupyterlab_lsp||[]).push([[364],{4988:(e,t,n)=>{"use strict";n.d(t,{Z:()=>o});var i=n(2609),s=n.n(i)()((function(e){return e[1]}));s.push([e.id,".lsp-floating-console {\n  position: absolute;\n  width: 600px;\n  min-height: 350px;\n  height: 25%;\n  right: 0;\n  bottom: 0;\n  background: rgba(255, 255, 255, 0.8);\n  border: 3px solid rgba(204, 204, 204, 0.7);\n  font-size: 12px;\n  overflow-y: auto;\n  margin: 0;\n  list-style-type: none;\n  padding: 5px;\n  z-index: 100;\n}\n\n.lsp-code {\n  font-family: monospace;\n  background: #eee;\n  border-radius: 2px;\n  padding: 2px 5px;\n}\n\n.lsp-kind {\n  padding: 2px 5px;\n}\n",""]);const o=s},2372:(e,t,n)=>{"use strict";n.d(t,{Z:()=>o});var i=n(2609),s=n.n(i)()((function(e){return e[1]}));s.push([e.id,".lsp-diagnostics-panel-content {\n  overflow-y: auto;\n}\n\n.lsp-diagnostics-listing {\n  color: var(--jp-ui-font-color1);\n  background: var(--jp-layout-color1);\n  font-size: var(--jp-ui-font-size1);\n  border-spacing: 0;\n  width: 100%;\n}\n\n.lsp-diagnostics-listing thead {\n  box-shadow: var(--jp-toolbar-box-shadow);\n}\n\n.lsp-diagnostics-listing tbody {\n  overflow-y: auto;\n  overflow-x: hidden;\n}\n\n.lsp-diagnostics-listing th,\n.lsp-diagnostics-listing td {\n  padding: 4px 12px 2px 12px;\n  height: 18px;\n}\n\n.lsp-diagnostics-listing th {\n  font-weight: 500;\n  text-align: left;\n  border-bottom: var(--jp-border-width) solid var(--jp-border-color1);\n  background: var(--jp-layout-color1);\n  position: sticky;\n  top: 0;\n  z-index: 2;\n  white-space: nowrap;\n  user-select: none;\n}\n\n.lsp-diagnostics-listing th:not(:first-child) {\n  border-left: var(--jp-border-width) solid var(--jp-border-color2);\n}\n\n.lsp-diagnostics-listing th:hover {\n  background: var(--jp-layout-color2);\n}\n\n.lsp-diagnostics-listing tbody tr:hover {\n  background: var(--jp-layout-color2);\n}\n\n.lsp-diagnostics-listing thead th > div {\n  flex-direction: row;\n  display: flex;\n}\n\n.lsp-diagnostics-listing thead th > div > label {\n  flex: 1;\n  text-overflow: ellipsis;\n}\n\n.lsp-sort-icon {\n  flex: 0;\n  height: var(--jp-ui-font-size1);\n  width: var(--jp-ui-font-size1);\n}\n\n.lsp-sort-icon svg {\n  display: inline;\n  height: auto;\n}\n\n.lsp-diagnostics-listing thead th:not(.lsp-sorted-header) .lsp-sort-icon {\n  opacity: 0;\n}\n\n.lsp-diagnostics-listing thead th:not(.lsp-sorted-header):hover .lsp-sort-icon {\n  opacity: 0.5;\n}\n",""]);const o=s},3075:(e,t,n)=>{"use strict";n.d(t,{Z:()=>d});var i=n(2609),s=n.n(i),o=n(8996),r=n(6801),a=n(2361),l=n(6143),c=s()((function(e){return e[1]}));c.i(o.Z),c.i(r.Z),c.i(a.Z),c.i(l.Z),c.push([e.id,'.cm-lsp-diagnostic {\n  text-decoration-line: underline;\n  /* For Chrome */\n  text-decoration-skip-ink: none;\n}\n\n.cm-lsp-diagnostic-Error {\n  /*\n    "wavy" would be ideal, but there seems to be a bug in Chrome which makes it\n    fail to render the last character see:\n    https://stackoverflow.com/questions/57559588/how-to-make-the-wavy-underline-extend-cover-all-the-characters-in-chrome\n    an alternative would be to use background image trick to simulate the underline\n  */\n\n  text-decoration-style: var(\n    --jp-editor-mirror-lsp-diagnostic-decoration-style\n  );\n  text-decoration-color: var(\n    --jp-editor-mirror-lsp-diagnostic-error-decoration-color\n  );\n}\n\n.cm-lsp-diagnostic-Warning {\n  text-decoration-style: var(\n    --jp-editor-mirror-lsp-diagnostic-decoration-style\n  );\n  text-decoration-color: var(\n    --jp-editor-mirror-lsp-diagnostic-warning-decoration-color\n  );\n}\n\n.cm-lsp-diagnostic-Information {\n  text-decoration-style: var(\n    --jp-editor-mirror-lsp-diagnostic-decoration-style\n  );\n  text-decoration-color: var(\n    --jp-editor-mirror-lsp-diagnostic-information-decoration-color\n  );\n}\n\n.cm-lsp-diagnostic-Hint {\n  text-decoration-style: var(\n    --jp-editor-mirror-lsp-diagnostic-decoration-style\n  );\n  text-decoration-color: var(\n    --jp-editor-mirror-lsp-diagnostic-hint-decoration-color\n  );\n}\n\n/* hover */\n.cm-lsp-hover-available {\n  text-decoration: var(--jp-editor-mirror-lsp-hover-decoration-style);\n  text-decoration-color: var(--jp-editor-mirror-lsp-hover-decoration-color);\n  text-decoration-line: underline;\n  text-decoration-skip-ink: none;\n}\n\n/* highlight */\n.cm-lsp-highlight {\n  background-color: var(--jp-editor-mirror-lsp-highlight-background-color);\n}\n',""]);const d=c},9719:(e,t,n)=>{"use strict";n.d(t,{Z:()=>o});var i=n(2609),s=n.n(i)()((function(e){return e[1]}));s.push([e.id,".lsp-hover .jp-RenderedHTMLCommon {\n  /* Reduce the default padding from 20px to 0px */\n  padding-right: 0px;\n}\n\n.lsp-hover .jp-RenderedHTMLCommon > *:last-child {\n  /* Reduce the default margin */\n  margin-bottom: 0;\n}\n",""]);const o=s},4599:(e,t,n)=>{"use strict";n.d(t,{Z:()=>l});var i=n(2609),s=n.n(i),o=n(3075),r=n(9719),a=s()((function(e){return e[1]}));a.i(o.Z),a.i(r.Z),a.push([e.id,".lsp-document-locator:hover {\n  cursor: pointer;\n}\n\n.lsp-document-locator span:not(:last-child)::after {\n  content: ' > ';\n}\n\n.lsp-icon-flip-x {\n  transform: scaleX(-1);\n  transform-origin: center center;\n}\n\n.lsp-external-link {\n  color: var(--jp-content-link-color);\n}\n",""]);const l=a},4929:(e,t,n)=>{"use strict";n.d(t,{Z:()=>o});var i=n(2609),s=n.n(i)()((function(e){return e[1]}));s.push([e.id,".lsp-popover {\n  /* jupyterlab Menu */\n  z-index: 10000;\n  padding: 4px 0px;\n  background: var(--jp-layout-color0);\n  color: var(--jp-ui-font-color1);\n  border: var(--jp-border-width) solid var(--jp-border-color1);\n  font-size: var(--jp-ui-font-size1);\n  box-shadow: var(--jp-elevation-z6);\n}\n\n.lsp-popover-content {\n  padding: 5px 10px;\n}\n\n.lsp-servers-title {\n  margin-bottom: 5px;\n}\n\n.lsp-servers-menu {\n  height: 350px;\n  overflow-y: auto;\n}\n\n.lsp-server-status,\n.lsp-missing-server,\n.lsp-documents-by-language {\n  margin-left: 20px;\n}\n\nh5 .lsp-language-server-name {\n  color: var(--jp-ui-font-color2);\n}\n\n.lsp-documents-by-language ul,\n.lsp-server-status ul {\n  margin: 0;\n  padding-left: 25px;\n}\n\n.lsp-servers-menu h5 {\n  font-weight: normal;\n  font-size: 100%;\n  white-space: nowrap;\n}\n\n.lsp-servers-lists {\n  margin-left: 5px;\n}\n\n.lsp-popover-status {\n  padding-top: 5px;\n  border-top: 1px solid var(--jp-border-color1);\n}\n\n.lsp-popover-status a {\n  color: var(--jp-content-link-color);\n}\n\n.lsp-servers-menu h3,\nh4,\nh5 {\n  margin: 0;\n}\n\n.lsp-documents-by-language li {\n  width: 100%;\n  display: flex;\n  justify-content: space-between;\n}\n\n.lsp-document-status {\n  float: right;\n  padding-left: 15px;\n}\n\n.lsp-document-status-icon {\n  margin-left: 5px;\n  position: relative;\n  top: 3px;\n}\n\n.lsp-collapsible-list h4 {\n  cursor: pointer;\n}\n\n.lsp-collapsible-list .lsp-caret-icon {\n  position: relative;\n  top: 3px;\n}\n\n.lsp-collapsible-list.lsp-collapsed div {\n  display: none;\n}\n\n.lsp-statusbar-item {\n  overflow: hidden;\n  white-space: nowrap;\n}\n\n.lsp-status-icon.ready svg g {\n  fill: var(--jp-success-color0);\n}\n\n.lsp-status-icon.preparing svg g {\n  fill: var(--jp-warn-color0);\n}\n\n.lsp-status-icon.error svg g {\n  fill: var(--jp-error-color0);\n}\n\n.lsp-status-icon.inactive svg g {\n  fill: var(--jp-layout-color3);\n}\n\nbody[data-jp-theme-light='false'] .lsp-status-icon.ready svg g {\n  fill: var(--jp-success-color1);\n}\n\n.lsp-statusbar-item.jp-mod-selected .jp-icon-selectable[fill] {\n  fill: #fff;\n}\n\n.jp-ToolbarButton .lsp-status-icon svg {\n  top: 5px;\n}\n",""]);const o=s},8996:(e,t,n)=>{"use strict";n.d(t,{Z:()=>o});var i=n(2609),s=n.n(i)()((function(e){return e[1]}));s.push([e.id,":root {\n  /* highlight */\n  --jp-editor-mirror-lsp-highlight-background-color: var(--jp-layout-color2);\n  /* diagnostics */\n  --jp-editor-mirror-lsp-diagnostic-decoration-style: dashed;\n  --jp-editor-mirror-lsp-diagnostic-error-decoration-color: var(\n    --jp-error-color1\n  );\n  --jp-editor-mirror-lsp-diagnostic-warning-decoration-color: var(\n    --jp-warn-color1\n  );\n  --jp-editor-mirror-lsp-diagnostic-information-decoration-color: var(\n    --jp-info-color1\n  );\n  --jp-editor-mirror-lsp-diagnostic-hint-decoration-color: var(\n    --jp-success-color1\n  );\n  /* hover */\n  --jp-editor-mirror-lsp-hover-decoration-style: dotted;\n  --jp-editor-mirror-lsp-hover-decoration-color: var(--jp-brand-color1);\n}\n",""]);const o=s},6801:(e,t,n)=>{"use strict";n.d(t,{Z:()=>o});var i=n(2609),s=n.n(i)()((function(e){return e[1]}));s.push([e.id,".cm-s-abcdef {\n  --jp-editor-mirror-lsp-highlight-background-color: rgba(144, 199, 255, 0.2);\n}\n\n.cm-s-base16-dark {\n  --jp-editor-mirror-lsp-highlight-background-color: rgba(239, 231, 171, 0.2);\n}\n\n.cm-s-base16-light {\n  --jp-editor-mirror-lsp-highlight-background-color: rgba(186, 192, 161, 0.1);\n}\n\n.cm-s-default {\n  --jp-editor-mirror-lsp-highlight-background-color: rgba(18, 69, 255, 0.1);\n}\n\n.cm-s-hopscotch {\n  --jp-editor-mirror-lsp-highlight-background-color: rgba(207, 18, 255, 0.2);\n}\n\n.cm-s-material {\n  --jp-editor-mirror-lsp-highlight-background-color: rgba(18, 255, 58, 0.2);\n}\n\n.cm-s-mbo {\n  --jp-editor-mirror-lsp-highlight-background-color: rgba(239, 231, 171, 0.2);\n}\n\n.cm-s-material {\n  --jp-editor-mirror-lsp-highlight-background-color: rgba(239, 231, 171, 0.2);\n}\n\n.cm-s-mdn-like {\n  --jp-editor-mirror-lsp-highlight-background-color: rgba(18, 69, 255, 0.1);\n}\n\n.cm-s-seti {\n  --jp-editor-mirror-lsp-highlight-background-color: rgba(239, 231, 171, 0.2);\n}\n\n.cm-s-solarized {\n  --jp-editor-mirror-lsp-highlight-background-color: rgba(18, 69, 255, 0.1);\n}\n\n.cm-s-the-matrix {\n  --jp-editor-mirror-lsp-highlight-background-color: rgba(239, 231, 171, 0.1);\n}\n\n.cm-s-xq-light {\n  --jp-editor-mirror-lsp-highlight-background-color: rgba(18, 69, 255, 0.1);\n}\n\n.cm-s-zenburn {\n  --jp-editor-mirror-lsp-highlight-background-color: rgba(239, 231, 171, 0.2);\n}\n",""]);const o=s},2361:(e,t,n)=>{"use strict";n.d(t,{Z:()=>o});var i=n(2609),s=n.n(i)()((function(e){return e[1]}));s.push([e.id,"body[data-jp-theme-light='false'] .cm-s-jupyter {\n  --jp-editor-mirror-lsp-highlight-background-color: rgba(151, 173, 255, 0.3);\n}\n",""]);const o=s},6143:(e,t,n)=>{"use strict";n.d(t,{Z:()=>o});var i=n(2609),s=n.n(i)()((function(e){return e[1]}));s.push([e.id,"body[data-jp-theme-light='true'] .cm-s-jupyter {\n  --jp-editor-mirror-lsp-highlight-background-color: rgba(18, 69, 255, 0.1);\n}\n",""]);const o=s},5384:(e,t,n)=>{"use strict";n.d(t,{wo:()=>s,Uu:()=>r,OC:()=>a,kZ:()=>l});var i=n(1797);const s="lsp-completer-theme-";var o;!function(e){e[e.Text=1]="Text",e[e.Method=2]="Method",e[e.Function=3]="Function",e[e.Constructor=4]="Constructor",e[e.Field=5]="Field",e[e.Variable=6]="Variable",e[e.Class=7]="Class",e[e.Interface=8]="Interface",e[e.Module=9]="Module",e[e.Property=10]="Property",e[e.Unit=11]="Unit",e[e.Value=12]="Value",e[e.Enum=13]="Enum",e[e.Keyword=14]="Keyword",e[e.Snippet=15]="Snippet",e[e.Color=16]="Color",e[e.File=17]="File",e[e.Reference=18]="Reference",e[e.Folder=19]="Folder",e[e.EnumMember=20]="EnumMember",e[e.Constant=21]="Constant",e[e.Struct=22]="Struct",e[e.Event=23]="Event",e[e.Operator=24]="Operator",e[e.TypeParameter=25]="TypeParameter"}(o||(o={}));const r="@krassowski/completion-manager",a="Kernel",l=new i.Token(r+":ILSPCompletionThemeManager")},4364:(e,t,n)=>{"use strict";n.r(t),n.d(t,{FeatureManager:()=>Un,ILSPAdapterManager:()=>a,ILSPCodeExtractorsManager:()=>c,ILSPCodeOverridesManager:()=>p,ILSPFeatureManager:()=>r,ILSPLogConsole:()=>d,ILSPVirtualEditorManager:()=>l,ILanguageServerManager:()=>i,LSPExtension:()=>Bn,PLUGIN_ID:()=>o,RegExpForeignCodeExtractor:()=>g,default:()=>Jn});var i,s=n(1797);!function(e){e.URL_NS="lsp"}(i||(i={}));const o="@krassowski/jupyterlab-lsp",r=new s.Token(o+":ILSPFeatureManager"),a=new s.Token(o+":ILSPAdapterManager"),l=new s.Token(o+":ILSPVirtualEditorManager"),c=new s.Token(o+":ILSPCodeExtractorsManager"),d=new s.Token(o+":ILSPLogConsole");function h(e,t){let n=0,i=0;for(let s of t){if(!(s.length+1<=e)){i=e;break}e-=s.length+1,n+=1}return{line:n,column:i}}function u(e,t,n=!1){let i=n?0:1,s=0;for(let n=0;n<t.length;n++){let o=t[n];if(!(e.line>n)){s+=e.column;break}s+=o.length+i}return s}function _(e,t,n){let i=e.exec(t),s=0,o=i[0];for(let e of i.slice(1)){if(void 0===e)continue;if(e===n){s+=o.indexOf(e);break}let t=o.indexOf(e)+e.length;o=o.slice(t),s+=t}return s}class g{constructor(e){this.language=e.language,this.options=e,this.global_expression=new RegExp(e.pattern,"g"),this.test_expression=new RegExp(e.pattern,"g"),this.expression=new RegExp(e.pattern),this.standalone=this.options.is_standalone,this.file_extension=this.options.file_extension}has_foreign_code(e){let t=this.test_expression.test(e);return this.test_expression.lastIndex=0,t}extract_foreign_code(e){let t,n,i=e.split("\n"),s=new Array,o=this.global_expression.lastIndex,r=this.global_expression.exec(e),a=!1;for(void 0!==this.options.foreign_replacer?(n=this.options.foreign_replacer,a=!0):void 0!==this.options.foreign_capture_groups?(n="$"+this.options.foreign_capture_groups.join("$"),a=!0):n=this.options.extract_to_foreign;null!=r;){let l=r[0],c=null,d=l.replace(this.expression,n),u="";void 0!==this.options.extract_arguments&&(u=l.replace(this.expression,this.options.extract_arguments),c=h(u.length,u.split("\n")));let g=this.global_expression.lastIndex;t=this.options.keep_in_host||null==this.options.keep_in_host?e.substring(o,g):o===r.index?"":e.substring(o,r.index)+"\n";let p=d;a&&(p=l.replace(this.expression,"$"+Math.min(...this.options.foreign_capture_groups)));const m=_(this.expression,l,p);let f=r.index+m,v=h(f,i),w=h(f+d.length,i);s.push({host_code:t,foreign_code:u+d,range:{start:v,end:w},virtual_shift:c}),o=this.global_expression.lastIndex,r=this.global_expression.exec(e)}if(o!==e.length){let t=e.substring(o,e.length);s.push({host_code:t,foreign_code:null,range:null,virtual_shift:null})}return s}}const p=new s.Token(o+":ILSPCodeOverridesManager");var m=n(6761),f=n(138),v=n(9373),w=n(3098),y=n(7904),b=n(1527),x=n(1503),k=n(4131),C=n(4814),S=n(2925),E=n(6168),M=n(6062),j=n.n(M),I=n(4599);j()(I.Z,{insert:"head",singleton:!1}),I.Z.locals;class T{constructor(e){this.shell=e,this.adapters=new Map,this.adapterChanged=new E.Signal(this),this.adapterDisposed=new E.Signal(this),this.adapterTypeAdded=new E.Signal(this),this.adapterTypes=[],e.currentChanged.connect(this.refreshAdapterFromCurrentWidget,this)}get types(){return this.adapterTypes}registerAdapterType(e){this.adapterTypes.push(e),this.adapterTypeAdded.emit(e)}connect(e,t){t.tracker.widgetAdded.connect(((n,i)=>{this.connectWidget(e,i,t)})),e.registerAdapterType(this,t)}registerExtension(e){for(let t of this.adapterTypes)this.connect(e,t);this.adapterTypeAdded.connect(((t,n)=>{this.connect(e,n)}))}connectWidget(e,t,n){let i=new n.adapter(e,t);this.registerAdapter({adapter:i,id:n.get_id(t),re_connector:()=>{this.connectWidget(e,t,n)}}),this.refreshAdapterFromCurrentWidget()}refreshAdapterFromCurrentWidget(){const e=this.shell.currentWidget;if(!e)return;let t=null;for(let n of this.adapterTypes)if(n.tracker.has(e)){let i=n.get_id(e);t=this.adapters.get(i)}null!=t&&(this.currentAdapter=t,this.adapterChanged.emit(t))}registerAdapter(e){let{id:t,adapter:n,re_connector:i}=e,s=e.adapter.widget;if(this.adapters.has(t)){let e=this.adapters.get(t);console.warn(`Adapter with id ${t} was already registered (${n} vs ${e}) `)}this.adapters.set(t,n);const o=()=>{this.adapters.delete(t),s.disposed.disconnect(o),s.context.pathChanged.disconnect(r),n.dispose()},r=()=>{o(),i()};s.disposed.connect((()=>{o(),this.adapterDisposed.emit(n)})),s.context.pathChanged.connect(r),this.refreshAdapterFromCurrentWidget()}isAnyActive(){return this.shell.currentWidget&&this.adapterTypes.some((e=>e.tracker.currentWidget))&&this.adapterTypes.some((e=>e.tracker.currentWidget==this.shell.currentWidget))}}const L={id:o+":ILSPAdapterManager",activate:e=>{let t=e.shell;return new T(t)},provides:a,autoStart:!0};var R=n(6632);class A{static lsp_to_cm(e){return{line:e.line,ch:e.character}}static cm_to_lsp(e){return{line:e.line,character:e.ch}}static lsp_to_ce(e){return{line:e.line,column:e.character}}static cm_to_ce(e){return{line:e.line,column:e.ch}}static ce_to_cm(e){return{line:e.line,ch:e.column}}}var P,D=n(3886),O=n(6988);class z{constructor(e){this.on_new_connection=e=>{e.on("error",(t=>{this.console.warn(t);let n=t.length&&t.length>=1?t[0]:new Error;-1!==n.message.indexOf("code = 1005")?(this.console.warn("Connection failed for "+e),this.forEachDocumentOfConnection(e,(t=>{this.console.warn("disconnecting "+t.uri),this.closed.emit({connection:e,virtual_document:t}),this.ignored_languages.add(t.language),this.console.warn(`Cancelling further attempts to connect ${t.uri} and other documents for this language (no support from the server)`)}))):-1!==n.message.indexOf("code = 1006")?this.console.warn("Connection closed by the server"):this.console.error("Connection error:",t)})),e.on("serverInitialized",(t=>{this.forEachDocumentOfConnection(e,(t=>{this.initialized.emit({connection:e,virtual_document:t})})),this.updateServerConfigurations(this.initial_configurations)})),e.on("close",(t=>{t?(this.console.warn("Connection closed"),this.forEachDocumentOfConnection(e,(t=>{this.closed.emit({connection:e,virtual_document:t})}))):this.console.warn("Connection unexpectedly disconnected")}))},this.connections=new Map,this.documents=new Map,this.ignored_languages=new Set,this.connected=new E.Signal(this),this.initialized=new E.Signal(this),this.disconnected=new E.Signal(this),this.closed=new E.Signal(this),this.documents_changed=new E.Signal(this),this.language_server_manager=e.language_server_manager,this.console=e.console,P.setLanguageServerManager(e.language_server_manager)}connect_document_signals(e){e.foreign_document_opened.connect(this.on_foreign_document_opened,this),e.foreign_document_closed.connect(this.on_foreign_document_closed,this),this.documents.set(e.uri,e),this.documents_changed.emit(this.documents)}disconnect_document_signals(e,t=!0){e.foreign_document_opened.disconnect(this.on_foreign_document_opened,this),e.foreign_document_closed.disconnect(this.on_foreign_document_closed,this),this.documents.delete(e.uri);for(const t of e.foreign_documents.values())this.disconnect_document_signals(t,!1);t&&this.documents_changed.emit(this.documents)}on_foreign_document_opened(e,t){this.console.log("ConnectionManager received foreign document: ",t.foreign_document.uri)}on_foreign_document_closed(e,t){const{foreign_document:n}=t;this.disconnect_document_signals(n)}async connect_socket(e){this.console.log("Connection Socket",e);let{virtual_document:t,language:n}=e;this.connect_document_signals(t);const i=z.solve_uris(t,n),s=this.language_server_manager.getMatchingServers({language:n});this.console.debug("Matching servers: ",s);const o=0===s.length?null:s[0],r=await P.connection(n,o,i,this.on_new_connection,this.console);return this.connections.set(t.uri,r),r}updateConfiguration(e){this.language_server_manager.setConfiguration(e)}updateServerConfigurations(e){let t;for(t in e){if(!e.hasOwnProperty(t))continue;const n=e[t],i={settings:(0,O.HY)(n.serverSettings)};this.console.log("Server Update: ",t),this.console.log("Sending settings: ",i),P.updateServerConfiguration(t,i)}}forEachDocumentOfConnection(e,t){for(const[n,i]of this.connections.entries())e===i&&t(this.documents.get(n))}async retry_to_connect(e,t,n=-1){let{virtual_document:i}=e;if(this.ignored_languages.has(i.language))return;let s=1e3*t,o=!1;for(;0!==n&&!o;)await this.connect(e).then((()=>{o=!0})).catch((e=>{this.console.warn(e)})),this.console.log("will attempt to re-connect in "+s/1e3+" seconds"),await(0,O._v)(s),s=s<5e3?s+500:s}async connect(e,t=30,n=5){this.console.log("connection requested",e);let i=await this.connect_socket(e),{virtual_document:s,document_path:o}=e;if(!i.isReady)try{await(0,O.EU)((()=>i.isReady),Math.round(1e3*t/150),150)}catch(e){this.console.warn(`Connection to ${s.uri} timed out after ${t} seconds, will continue retrying for another ${n} minutes`);try{await(0,O.EU)((()=>i.isReady),60*n,1e3)}catch(e){return void this.console.warn(`Connection to ${s.uri} timed out again after ${n} minutes, giving up`)}}return this.console.log(o,s.uri,"connected."),this.connected.emit({connection:i,virtual_document:s}),i}unregister_document(e){this.connections.delete(e.uri),this.documents_changed.emit(this.documents)}updateLogging(e,t){for(const n of this.connections.values())n.logAllCommunication=e,null!==t&&n.clientNotifications["$/setTrace"].emit({value:t})}}!function(e){e.solve_uris=function(e,t){const n=D.PageConfig.getBaseUrl().replace(/^http/,"ws"),s=D.PageConfig.getOption("rootUri"),o=D.PageConfig.getOption("virtualDocumentsUri"),r=e.has_lsp_supported_file?s:o,a=P.getLanguageServerManager().getMatchingServers({language:t}),l=0===a.length?null:a[0];if(null===l)throw"No language server installed for language "+t;let c=D.URLExt.join(r,e.uri);return!c.startsWith("file:///")&&c.startsWith("file://")&&(c=c.replace("file://","file:///"),c.startsWith("file:///users/")&&r.startsWith("file:///Users/")&&(c=c.replace("file:///users/","file:///Users/"))),{base:r,document:c,server:D.URLExt.join("ws://jupyter-lsp",t),socket:D.URLExt.join(n,i.URL_NS,"ws",l)}}}(z||(z={})),function(e){const t=new Map;let i,s;e.getLanguageServerManager=function(){return s},e.setLanguageServerManager=function(e){s=e},e.connection=async function(e,s,o,r,a){null==i&&(i=n.e(16).then(n.bind(n,7811)));const{LSPConnection:l}=await i;let c=t.get(s);if(null==c){const n=new WebSocket(o.socket),i=new l({languageId:e,serverUri:o.server,rootUri:o.base,serverIdentifier:s,console:a});i.setMaxListeners(999),t.set(s,i),i.connect(n),r(i)}return c=t.get(s),c},e.updateServerConfiguration=function(e,n){const i=t.get(e);i&&i.sendConfigurationChange(n)}}(P||(P={}));class $ extends Map{constructor(e){super(e.map((e=>[new RegExp(e.pattern),e.replacement])))}_override_for(e){for(let[t,n]of this)if(e.match(t))return e.replace(t,n);return null}}class F extends ${constructor(e){super(e),this.overrides=e}get reverse(){return this.type(this.overrides.map((e=>e.reverse)))}type(e){return new F(e)}override_for(e){return super._override_for(e)}replace_all(e,t=this){let n=new Array,i=new Array;for(let s=0;s<e.length;s++){let o=e[s],r=t.override_for(o);n.push(null==r?o:r),i.push(null!=r)}return{lines:n,skip_inspect:i}}reverse_replace_all(e){return this.replace_all(e,this.reverse).lines}}var q=n(4988);function H(e){return e.map((e=>{let t;if("string"==typeof e)return e;try{t=JSON.stringify({k:e}).slice(5,-1)}catch(n){t=""+e}return'<span class="lsp-code">'+t+"</span>"})).join(" ")}j()(q.Z,{insert:"head",singleton:!1}),q.Z.locals;class N{constructor(e=["LSP"],t=null){t?this.element=t:(this.element=document.createElement("ul"),this.element.className="lsp-floating-console",document.body.appendChild(this.element))}bindThis(){return this}dispose(){this.element.remove()}append(e,t="log"){let n=document.createElement("li");n.innerHTML='<span class="lsp-kind">'+t+"</span>"+e,this.element.appendChild(n),this.element.scrollTop=this.element.scrollHeight}debug(...e){this.append(H(e),"debug")}log(...e){this.append(H(e),"log")}warn(...e){this.append(H(e),"warn")}error(...e){this.append(H(e),"error")}}class W{constructor(){this.debug=window.console.debug.bind(window.console),this.log=window.console.log.bind(window.console),this.warn=window.console.warn.bind(window.console),this.error=window.console.error.bind(window.console)}dispose(){}scope(e){return this}bindThis(){return window.console}}class V{constructor(e=["LSP"],t){this.breadcrumbs=e,this._scope=this.breadcrumbs.join(".")+":",this.singleton=t,this.singleton.changed.connect(this._rebind_functions.bind(this)),this._rebind_functions()}_rebind_functions(){const e=()=>{},t=this.implementation.bindThis();"debug"===this.verbosity?this.debug=this.implementation.debug.bind(t,this._scope):this.debug=e,"debug"===this.verbosity||"log"===this.verbosity?this.log=this.implementation.log.bind(t,this._scope):this.log=e,"debug"===this.verbosity||"log"===this.verbosity||"warn"===this.verbosity?this.warn=this.implementation.warn.bind(t,this._scope):this.warn=e,this.error=this.implementation.error.bind(t,this._scope)}get verbosity(){return this.singleton.verbosity}get implementation(){return this.singleton.implementation}debug(...e){return this.implementation.debug(this._scope,...e)}log(...e){return this.implementation.log(this._scope,...e)}warn(...e){return this.implementation.warn(this._scope,...e)}error(...e){return this.implementation.error(this._scope,...e)}scope(e){return new V([...this.breadcrumbs,e],this.singleton)}}class U{constructor(e){this.verbosity="debug",this.implementation=new W,this.changed=new E.Signal(this),e.load(o+":plugin").then((e=>{this.updateSettings(e),e.changed.connect((()=>{this.updateSettings(e)}))})).catch(console.warn)}updateSettings(e){const t=e.composite,n=t.loggingConsole;this.implementation&&this.implementation.dispose(),"browser"===n?this.implementation=new W:"floating"===n?this.implementation=new N:(console.warn("Unknown console type",n,"falling back to browser console"),this.implementation=new W),this.verbosity=t.loggingLevel,this.changed.emit()}}const B={id:o+":ILSPLogConsole",requires:[y.ISettingRegistry],activate:(e,t)=>{const n=new U(t);return new V(["LSP"],n)},provides:d,autoStart:!0};function Z(e,t){return t.start.line===t.end.line?e.line===t.start.line&&e.column>=t.start.column&&e.column<=t.end.column:e.line===t.start.line&&e.column>=t.start.column&&e.line<t.end.line||e.line>t.start.line&&e.column<=t.end.column&&e.line===t.end.line||e.line>t.start.line&&e.line<t.end.line}class K{constructor(e){this.version=0,this._document=e}get text(){return this._document.value}get uri(){return z.solve_uris(this._document,this.languageId).document}get languageId(){return this._document.language}}class J{constructor(e){this.isDisposed=!1,this.blank_lines_between_cells=2,this.options=e,this.path=e.path,this.file_extension=e.file_extension,this.has_lsp_supported_file=e.has_lsp_supported_file,this.parent=e.parent,this.language=e.language;let t=this.language in e.overrides_registry?e.overrides_registry[this.language]:null;this.cell_magics_overrides=new F(t?t.cell:[]),this.line_magics_overrides=new F(t?t.line:[]),this.foreign_extractors_registry=e.foreign_code_extractors,this.foreign_extractors=this.language in this.foreign_extractors_registry?this.foreign_extractors_registry[this.language]:[],this.virtual_lines=new Map,this.source_lines=new Map,this.foreign_documents=new Map,this.overrides_registry=e.overrides_registry,this.standalone=e.standalone,this.instance_id=J.instances_count,J.instances_count+=1,this.unused_standalone_documents=new O.Gl((()=>new Array)),this._remaining_lifetime=6,this.foreign_document_closed=new E.Signal(this),this.foreign_document_opened=new E.Signal(this),this.changed=new E.Signal(this),this.unused_documents=new Set,this.document_info=new K(this),this.update_manager=new X(this,e.console),this.clear()}dispose(){if(!this.isDisposed){this.isDisposed=!0,this.parent=null;for(const e of this.foreign_documents.values())e.dispose();this.close_all_foreign_documents(),this.update_manager.dispose(),this.foreign_documents.clear(),this.source_lines.clear(),this.unused_documents.clear(),this.unused_standalone_documents.clear(),this.virtual_lines.clear(),this.cell_magics_overrides=null,this.document_info=null,this.foreign_extractors=null,this.foreign_extractors_registry=null,this.line_magics_overrides=null,this.line_blocks=null,this.overrides_registry=null}}get remaining_lifetime(){return this.parent?this._remaining_lifetime:1/0}set remaining_lifetime(e){this.parent&&(this._remaining_lifetime=e)}clear(){this.unused_standalone_documents.clear();for(let e of this.foreign_documents.values())e.clear(),e.standalone&&this.unused_standalone_documents.get(e.language).push(e);this.unused_documents=new Set(this.foreign_documents.values()),this.virtual_lines.clear(),this.source_lines.clear(),this.last_virtual_line=0,this.last_source_line=0,this.line_blocks=[]}forward_closed_signal(e,t){this.foreign_document_closed.emit(t)}forward_opened_signal(e,t){this.foreign_document_opened.emit(t)}open_foreign(e,t,n){let i=new J(Object.assign(Object.assign({},this.options),{parent:this,standalone:t,file_extension:n,language:e}));const s={foreign_document:i,parent_host:this};return this.foreign_document_opened.emit(s),i.foreign_document_closed.connect(this.forward_closed_signal,this),i.foreign_document_opened.connect(this.forward_opened_signal,this),this.foreign_documents.set(i.virtual_id,i),i}document_at_source_position(e){let t=this.source_lines.get(e.line);if(null==t)return this;let n={line:t.editor_line,column:e.ch};for(let[e,{virtual_document:i}]of t.foreign_documents_map)if(Z(n,e)){let t={line:n.line-e.start.line,ch:n.column-e.start.column};return i.document_at_source_position(t)}return this}is_within_foreign(e){let t=this.source_lines.get(e.line),n={line:t.editor_line,column:e.ch};for(let[e]of t.foreign_documents_map)if(Z(n,e))return!0;return!1}virtual_position_at_document(e){let t=this.source_lines.get(e.line),n=t.virtual_line,i={line:t.editor_line,column:e.ch};for(let[e,{virtual_line:n,virtual_document:s}]of t.foreign_documents_map)if(Z(i,e)){let t={line:i.line-e.start.line,ch:i.column-e.start.column};return s.is_within_foreign(t)?this.virtual_position_at_document(t):(t.line+=n,t)}return{ch:e.ch,line:n}}choose_foreign_document(e){let t,n=this.foreign_documents.has(e.language);if(!e.standalone&&n)t=this.foreign_documents.get(e.language),this.unused_documents.delete(t);else{let n=this.unused_standalone_documents.get(e.language);e.standalone&&n.length>0?(t=n.pop(),this.unused_documents.delete(t)):t=this.open_foreign(e.language,e.standalone,e.file_extension)}return t}extract_foreign_code(e,t){let n=new Map,i=e.value;for(let s of this.foreign_extractors){if(!s.has_foreign_code(i))continue;let o=s.extract_foreign_code(i),r="";for(let i of o){if(null!==i.foreign_code){let o=this.choose_foreign_document(s);n.set(i.range,{virtual_line:o.last_virtual_line,virtual_document:o,editor:e.ce_editor});let r={line:t.line+i.range.start.line,column:t.column+i.range.start.column};o.append_code_block({value:i.foreign_code,ce_editor:e.ce_editor},r,i.virtual_shift)}null!=i.host_code&&(r+=i.host_code)}i=r}return{cell_code_kept:i,foreign_document_map:n}}decode_code_block(e){let t=this.cell_magics_overrides.reverse.override_for(e);return null!=t?t:this.line_magics_overrides.reverse_replace_all(e.split("\n")).join("\n")}prepare_code_block(e,t={line:0,column:0}){let n,i,{cell_code_kept:s,foreign_document_map:o}=this.extract_foreign_code(e,t),r=s,a=this.cell_magics_overrides.override_for(r);if(null!=a)n=a.split("\n"),i=n.map((e=>[this.id_path]));else{let e=this.line_magics_overrides.replace_all(r.split("\n"));n=e.lines,i=e.skip_inspect.map((e=>e?[this.id_path]:[]))}return{lines:n,foreign_document_map:o,skip_inspect:i}}get foreign_document_maps(){let e=new Set;for(let t of this.source_lines.values())e.add(t.foreign_documents_map);return[...e.values()]}append_code_block(e,t={line:0,column:0},n){let i=e.value,s=e.ce_editor;if(this.isDisposed)return void console.warn("Cannot append code block: document disposed");let o=i.split("\n"),{lines:r,foreign_document_map:a,skip_inspect:l}=this.prepare_code_block(e,t);for(let e=0;e<r.length;e++)this.virtual_lines.set(this.last_virtual_line+e,{skip_inspect:l[e],editor:s,source_line:this.last_source_line+e});for(let e=0;e<o.length;e++)this.source_lines.set(this.last_source_line+e,{editor_line:e,editor_shift:{line:t.line-((null==n?void 0:n.line)||0),column:0===e?t.column-((null==n?void 0:n.column)||0):0},editor:s,foreign_documents_map:a,virtual_line:this.last_virtual_line+e});this.last_virtual_line+=r.length,this.line_blocks.push(r.join("\n")+"\n");for(let e=0;e<this.blank_lines_between_cells;e++)this.virtual_lines.set(this.last_virtual_line+e,{skip_inspect:[this.id_path],editor:s,source_line:null});this.last_virtual_line+=this.blank_lines_between_cells,this.last_source_line+=o.length}get value(){let e="\n".repeat(this.blank_lines_between_cells);return this.line_blocks.join(e)}get last_line(){const e=this.line_blocks[this.line_blocks.length-1].split("\n");return e[e.length-1]}close_expired_documents(){for(let e of this.unused_documents.values())e.remaining_lifetime-=1,e.remaining_lifetime<=0&&this.close_foreign(e)}close_foreign(e){console.log("LSP: closing document",e),this.foreign_document_closed.emit({foreign_document:e,parent_host:this}),this.foreign_documents.delete(e.virtual_id),e.close_all_foreign_documents(),e.foreign_document_closed.disconnect(this.forward_closed_signal,this),e.foreign_document_opened.disconnect(this.forward_opened_signal,this)}close_all_foreign_documents(){for(let e of this.foreign_documents.values())this.close_foreign(e)}get virtual_id(){return this.standalone?this.instance_id+"("+this.language+")":this.language}get ancestry(){return this.parent?this.parent.ancestry.concat([this]):[this]}get id_path(){return this.parent?this.parent.id_path+"-"+this.virtual_id:this.virtual_id}get uri(){const e=encodeURI(this.path);return this.parent?e+"."+this.id_path+"."+this.file_extension:e}transform_source_to_editor(e){let t=this.source_lines.get(e.line),n=t.editor_line,i=t.editor_shift;return{ch:e.ch+(0===n?i.column:0),line:n+i.line}}transform_virtual_to_editor(e){let t=this.transform_virtual_to_source(e);return this.transform_source_to_editor(t)}transform_virtual_to_source(e){return{ch:e.ch,line:this.virtual_lines.get(e.line).source_line}}get root(){return null==this.parent?this:this.parent.root}get_editor_at_virtual_line(e){let t=e.line;return this.virtual_lines.has(t)||(t-=1),this.virtual_lines.get(t).editor}get_editor_at_source_line(e){return this.source_lines.get(e.line).editor}maybe_emit_changed(){this.value!==this.previous_value&&this.changed.emit(this),this.previous_value=this.value;for(let e of this.foreign_documents.values())e.maybe_emit_changed()}}function G(e){let t=new Set;t.add(e);for(let n of e.foreign_documents.values())G(n).forEach(t.add,t);return t}J.instances_count=0;class X{constructor(e,t){this.virtual_document=e,this.is_update_in_progress=!1,this.update_lock=!1,this.isDisposed=!1,this.update_done=new Promise((e=>{e()})),this.document_updated=new E.Signal(this),this.block_added=new E.Signal(this),this.update_began=new E.Signal(this),this.update_finished=new E.Signal(this),this.document_updated.connect(this.on_updated,this),this.console=t||new W}dispose(){this.isDisposed||this.document_updated.disconnect(this.on_updated,this)}on_updated(e,t){try{t.close_expired_documents()}catch(e){this.console.warn("Failed to close expired documents")}}can_update(){return!this.isDisposed&&!this.is_update_in_progress&&!this.update_lock}async with_update_lock(e){await(0,O.EU)((()=>this.can_update()),12,10).then((()=>{try{this.update_lock=!0,e()}finally{this.update_lock=!1}}))}async update_documents(e){let t=new Promise((async(t,n)=>{await(0,O.EU)((()=>this.can_update()),10,5).then((()=>{!this.isDisposed&&this.virtual_document||t();try{this.is_update_in_progress=!0,this.update_began.emit(e),this.virtual_document.clear();for(let t of e)this.block_added.emit({block:t,virtual_document:this.virtual_document}),this.virtual_document.append_code_block(t);this.update_finished.emit(e),this.virtual_document&&(this.document_updated.emit(this.virtual_document),this.virtual_document.maybe_emit_changed()),t()}catch(e){this.console.warn("Documents update failed:",e),n(e)}finally{this.is_update_in_progress=!1}}))}));return this.update_done=t,t}}class Y{constructor(e,t,n=new Array,i){this.editor=e,this.virtual_document=t,this.isDisposed=!1,this.editor.change.connect(this.saveChange,this),this.console=i.scope("EditorAdapter"),this.features=new Map;for(let e of n)e.register(),e.is_registered||this.console.warn("The feature ",e,"was not registered properly"),this.features.set(e.feature.id,e)}async updateAfterChange(){try{await(0,O.EU)((()=>null!=this.last_change),30,22)}catch(e){return void this.console.log("No change obtained from CodeMirror editor within the expected time of 0.66s")}let e,t=this.last_change;try{e=this.editor.get_cursor_position()}catch(e){return void this.console.log("Root position not found")}try{let n=this.editor.document_at_root_position(e);if(this.virtual_document!==n)return!0;if(!t||!t.text.length||!t.text[0].length)return!0;for(let n of this.features.values())try{n.afterChange(t,e)}catch(e){console.warn("afterChange of feature",n,"failed with",e)}return!0}catch(e){this.console.log("updateAfterChange failure"),this.console.error(e)}this.invalidateLastChange()}invalidateLastChange(){this.last_change=null}saveChange(e,t){this.last_change=t}dispose(){if(!this.isDisposed){for(let e of this.features.values())e.remove();this.features.clear(),this.editor.change.disconnect(this.saveChange),this.editor=null,this.isDisposed=!0}}}var Q=f.Dialog.createButton;class ee{constructor(){this.message="",this.changed=new E.Signal(this),this.timer=null}set(e,t=3e3){this.expire_timer(),this.message=e,this.changed.emit(),-1!==t&&(this.timer=window.setTimeout(this.clear.bind(this),t))}clear(){this.message="",this.changed.emit()}expire_timer(){null!==this.timer&&(window.clearTimeout(this.timer),this.timer=0)}}const te={"text/x-rsrc":"r","text/x-r-source":"r","text/x-ipython":"python"};class ne{constructor(e,t){this.extension=e,this.widget=t,this.isDisposed=!1,this.app=e.app,this.connection_manager=e.connection_manager,this.adapterConnected=new E.Signal(this),this.activeEditorChanged=new E.Signal(this),this.editorRemoved=new E.Signal(this),this.editorAdded=new E.Signal(this),this.adapters=new Map,this.status_message=new ee,this.isConnected=!1,this.console=e.console.scope("WidgetAdapter"),this.trans=(e.translator||x.nullTranslator).load("jupyterlab-lsp"),this.widget.context.saveState.connect(this.on_save_state,this),this.connection_manager.closed.connect(this.on_connection_closed,this),this.widget.disposed.connect(this.dispose,this)}get foreign_code_extractors(){return this.extension.foreign_code_extractors}get code_overrides(){return this.extension.code_overrides}on_connection_closed(e,{virtual_document:t}){var n;this.console.log("connection closed, disconnecting adapter",t.id_path),t===(null===(n=this.virtual_editor)||void 0===n?void 0:n.virtual_document)&&this.dispose()}dispose(){var e,t;this.isDisposed||((null===(e=this.virtual_editor)||void 0===e?void 0:e.virtual_document)&&this.disconnect_adapter(null===(t=this.virtual_editor)||void 0===t?void 0:t.virtual_document),this.widget.context.saveState.disconnect(this.on_save_state,this),this.connection_manager.closed.disconnect(this.on_connection_closed,this),this.widget.disposed.disconnect(this.dispose,this),this.disconnect(),this.virtual_editor=null,this.app=null,this.widget=null,this.connection_manager=null,this.widget=null,this.isDisposed=!0)}get widget_id(){return this.widget.id}get language(){if(te.hasOwnProperty(this.mime_type))return te[this.mime_type];{let e=this.mime_type.split(";")[0],[t,n]=e.split("/");return"application"===t||"text"===t?n.startsWith("x-")?n.substr(2):n:this.mime_type}}disconnect(){this.connection_manager.unregister_document(this.virtual_editor.virtual_document),this.widget.context.model.contentChanged.disconnect(this.onContentChanged,this);for(let e of this.editors)this.editorRemoved.emit({editor:e});for(let e of this.adapters.values())e.dispose();this.adapters.clear(),this.virtual_editor.dispose()}reload_connection(){null!=this.virtual_editor&&(this.disconnect(),this.init_virtual(),this.connect_document(this.virtual_editor.virtual_document,!0).catch(this.console.warn))}on_save_state(e,t){if(null!=this.virtual_editor&&"completed"===t){const e=[this.virtual_editor.virtual_document];for(let t of e){let n=this.connection_manager.connections.get(t.uri);this.console.log("Sending save notification for",t.uri,"to",n),n.sendSaved(t.document_info);for(let n of t.foreign_documents.values())e.push(n)}}}update_documents(){if(!this.isDisposed)return this.virtual_editor.virtual_document.update_manager.update_documents(this.editors.map((e=>({ce_editor:e,value:this.virtual_editor.get_editor_value(e)}))));this.console.warn("Cannot update documents: adapter disposed")}get has_multiple_editors(){return this.editors.length>1}async on_connected(e){let{virtual_document:t}=e;this.connect_adapter(e.virtual_document,e.connection),this.adapterConnected.emit(e),this.isConnected=!0,await this.update_documents().then((()=>{this.document_changed(t,t,!0),this.console.log("virtual document(s) for",this.document_path,"have been initialized")}));const n=t.uri,i=this.extension.user_console.getLogger(n);e.connection.serverNotifications["$/logTrace"].connect(((n,i)=>{this.console.log(e.connection.serverIdentifier,"trace",t.uri,i)})),e.connection.serverNotifications["window/logMessage"].connect(((n,s)=>{this.console.log(e.connection.serverIdentifier,t.uri,s),i.log({type:"text",data:n.serverIdentifier+": "+s.message})})),e.connection.serverNotifications["window/showMessage"].connect(((n,i)=>{this.console.log(e.connection.serverIdentifier,t.uri,i.message),(0,f.showDialog)({title:this.trans.__("Message from ")+n.serverIdentifier,body:i.message})})),e.connection.serverRequests["window/showMessageRequest"].setHandler((async n=>{this.console.log(e.connection.serverIdentifier,t.uri,n);const i=n.actions,s=i.map((e=>Q({label:e.title}))),o=await(0,f.showDialog)({title:this.trans.__("Message from ")+e.connection.serverIdentifier,body:n.message,buttons:s}),r=s.indexOf(o.button);if(-1!==r)return i[r]}))}async connect_document(e,t=!1){e.changed.connect(this.document_changed,this),e.foreign_document_opened.connect(this.on_foreign_document_opened,this);const n=await this.connect(e).catch(this.console.warn);t&&(n&&n.connection?n.connection.sendOpenWhenReady(e.document_info):this.console.warn(`Connection for ${e.path} was not opened`))}create_virtual_editor(e){let t=this.extension.editor_type_manager.findBestImplementation(this.editors);return null==t?null:new(0,t.implementation)(e)}init_virtual(){let e=this.create_virtual_editor({adapter:this,virtual_document:this.create_virtual_document()});null!=e?(this.virtual_editor=e,this.connect_contentChanged_signal()):this.console.error("Could not initialize a VirtualEditor for adapter: ",this)}async on_foreign_document_opened(e,t){const{foreign_document:n}=t;await this.connect_document(n,!0),n.foreign_document_closed.connect(this.on_foreign_document_closed,this)}on_foreign_document_closed(e,t){const{foreign_document:n}=t;n.foreign_document_closed.disconnect(this.on_foreign_document_closed,this),n.foreign_document_opened.disconnect(this.on_foreign_document_opened,this),n.changed.disconnect(this.document_changed,this)}document_changed(e,t,n=!1){if(this.isDisposed)return void this.console.warn("Cannot swap document: adapter disposed");let i=this.connection_manager.connections.get(e.uri),s=this.adapters.get(e.id_path);(null==i?void 0:i.isReady)?null!=s?(i.sendFullTextChange(e.value,e.document_info),n||this.virtual_editor.virtual_document.update_manager.with_update_lock((async()=>{await s.updateAfterChange()})).then().catch(this.console.warn)):this.console.log("Skipping document update signal: adapter not ready"):this.console.log("Skipping document update signal: connection not ready")}connect_adapter(e,t,n=null){let i=this.create_adapter(e,t,n);return this.adapters.set(e.id_path,i),i}disconnect_adapter(e){let t=this.adapters.get(e.id_path);this.adapters.delete(e.id_path),null!=t&&t.dispose()}get_features(e){let t=this.adapters.get(e.id_path);return null==t?void 0:t.features}async connect(e){let t=e.language;this.console.log("will connect using language: "+t);let n={virtual_document:e,language:t,document_path:this.document_path},i=await this.connection_manager.connect(n);return await this.on_connected({virtual_document:e,connection:i}),{connection:i,virtual_document:e}}connect_contentChanged_signal(){this.widget.context.model.contentChanged.connect(this.onContentChanged,this)}create_adapter(e,t,n=null){let i=new Array;null===n&&(n=this.extension.feature_manager.features);for(let s of n){let n=new(s.editorIntegrationFactory.get(this.virtual_editor.editor_name))({feature:s,virtual_editor:this.virtual_editor,virtual_document:e,connection:t,status_message:this.status_message,settings:s.settings,adapter:this,trans:this.trans});i.push(n)}let s=new Y(this.virtual_editor,e,i,this.console);return this.console.log("Adapter for",this.document_path,"is ready."),t.sendOpenWhenReady(e.document_info),s}async onContentChanged(e){this.update_finished=this.update_documents().catch(this.console.warn),await this.update_finished}get_position_from_context_menu(){let e=this.app.contextMenuHitTest((()=>!0)),{left:t,top:n}=e.getBoundingClientRect(),i=this.app._contextMenuEvent;return void 0!==i&&(t=i.clientX,n=i.clientY,i.stopPropagation()),this.virtual_editor.window_coords_to_root_position({left:t,top:n})}get_context(e){let t=this.virtual_editor.document_at_root_position(e),n=this.virtual_editor.root_position_to_virtual_position(e);return{document:t,connection:this.connection_manager.connections.get(t.uri),virtual_position:n,root_position:e,features:this.get_features(t),editor:this.virtual_editor,app:this.app,adapter:this}}get_context_from_context_menu(){let e=this.get_position_from_context_menu();return this.get_context(e)}}class ie extends ne{constructor(e,t){super(e,t),this.editor=t.content,this.init_virtual(),this.console.log("file ready for connection:",this.path),this.connect_document(this.virtual_editor.virtual_document,!1).catch(this.console.warn),this.editor.model.mimeTypeChanged.connect(this.reload_connection,this)}get document_path(){return this.widget.context.path}get mime_type(){return this.editor.model.mimeType}get language_file_extension(){let e=this.document_path.split(".");return e[e.length-1]}get ce_editor(){return this.editor.editor}get activeEditor(){return this.editor.editor}get_editor_index(e){return 0}get_editor_wrapper(e){return this.wrapper_element}get wrapper_element(){return this.widget.node}get path(){return this.widget.context.path}context_from_active_document(){let e=this.widget.content.editor.getCursorPosition(),t=A.ce_to_cm(e);return null==this?void 0:this.get_context(t)}get_editor_index_at(e){return 0}get editors(){return[this.editor.editor]}create_virtual_document(){return new J({language:this.language,file_extension:this.language_file_extension,path:this.document_path,overrides_registry:{},foreign_code_extractors:{},standalone:!0,has_lsp_supported_file:!0,console:this.console})}}const se={id:o+":FileEditorAdapter",requires:[a],optional:[R.IEditorTracker],activate(e,t,n){null===n?console.warn("LSP: no fileEditorTracker - not registering file editor capabilities"):t.registerAdapterType({name:"file_editor",tracker:n,adapter:ie,entrypoint:"file-editor-context-menu",get_id:e=>e.id,context_menu:{selector:".jp-FileEditor",rank_group:0,rank_group_size:4}})},autoStart:!0};var oe=n(8611);class re extends ne{constructor(e,t){super(e,t),this.type="code",this.is_ready=()=>{var e;return!this.widget.isDisposed&&this.widget.context.isReady&&this.widget.content.isVisible&&this.widget.content.widgets.length>0&&null!=(null===(e=this.widget.context.sessionContext.session)||void 0===e?void 0:e.kernel)},this.ce_editor_to_cell=new Map,this.editor=t.content,this.known_editors_ids=new Set,this.init_once_ready().catch(this.console.warn)}async update_language_info(){this._language_info=(await this.widget.context.sessionContext.session.kernel.info).language_info}async on_kernel_changed(e,t){if(t.newValue)try{await this.update_language_info(),this.console.log(`Changed to ${this._language_info.name} kernel, reconnecting`),await(0,O.EU)(this.is_ready,-1),this.reload_connection()}catch(e){this.console.warn(e),this.reload_connection()}else this.console.log("kernel was shut down")}dispose(){this.isDisposed||(this.widget.context.sessionContext.kernelChanged.disconnect(this.on_kernel_changed,this),this.widget.content.activeCellChanged.disconnect(this.activeCellChanged,this),super.dispose(),this.ce_editor_to_cell.clear())}get document_path(){return this.widget.context.path}language_info(){return this._language_info}get mime_type(){let e=this.language_info();return e?e.mimetype:this.widget.content.codeMimetype}get language_file_extension(){let e=this.language_info();return e?e.file_extension.replace(".",""):null}get wrapper_element(){return this.widget.node}async init_once_ready(){this.console.log("waiting for",this.document_path,"to fully load"),await this.widget.context.sessionContext.ready,await(0,O.EU)(this.is_ready,-1),await this.update_language_info(),this.console.log(this.document_path,"ready for connection"),this.init_virtual(),this.connect_document(this.virtual_editor.virtual_document,!1).catch(this.console.warn),this.widget.context.sessionContext.kernelChanged.connect(this.on_kernel_changed,this),this.widget.content.activeCellChanged.connect(this.activeCellChanged,this),this.widget.model.cells.changed.connect(this.handle_cell_change,this),this.editor.modelChanged.connect((e=>{this.console.warn("Model changed, connecting cell change handler; this is not something we were expecting"),e.model.cells.changed.connect(this.handle_cell_change,this)}))}async handle_cell_change(e,t){let n=[],i=[];const s=this.type;if("set"===t.type){let e=[],o=[];if(t.newValues.length===t.oldValues.length){for(let n=0;n<t.newValues.length;n++)t.oldValues[n].type===s&&t.newValues[n].type!==s?e.push(t.newValues[n]):t.oldValues[n].type!==s&&t.newValues[n].type===s&&o.push(t.newValues[n]);n=o,i=e}}else"add"==t.type&&(n=t.newValues.filter((e=>e.type===s)));(i.length||n.length||"move"===t.type||"remove"===t.type)&&await this.update_documents();for(let e of i){let t=this.widget.content.widgets.find((t=>t.model.id===e.id));this.known_editors_ids.delete(t.editor.uuid),this.editorRemoved.emit({editor:t.editor})}for(let e of n){let t=this.widget.content.widgets.find((t=>t.model.id===e.id));this.known_editors_ids.add(t.editor.uuid),this.editorAdded.emit({editor:t.editor})}}get editors(){if(this.isDisposed)return;let e=this.widget.content;return this.ce_editor_to_cell.clear(),e.isDisposed?[]:e.widgets.filter((e=>"code"===e.model.type)).map((e=>(this.ce_editor_to_cell.set(e.editor,e),e.editor)))}create_virtual_document(){return new J({language:this.language,path:this.document_path,overrides_registry:this.code_overrides,foreign_code_extractors:this.foreign_code_extractors,file_extension:this.language_file_extension,standalone:!1,has_lsp_supported_file:!1,console:this.console})}get activeEditor(){return this.widget.content.activeCell.editor}activeCellChanged(e,t){t.model.type===this.type&&(this.known_editors_ids.has(t.editor.uuid)||(this.known_editors_ids.add(t.editor.uuid),this.editorAdded.emit({editor:t.editor})),this.activeEditorChanged.emit({editor:t.editor}))}context_from_active_document(){let e=this.widget.content.activeCell;if(e.model.type!==this.type)return null;let t=e.editor,n=t.getCursorPosition(),i=A.ce_to_cm(n),s=null==this?void 0:this.virtual_editor;if(null==s)return null;let o=s.transform_from_editor_to_root(t,i);return null==o?(this.console.warn("Could not retrieve current context",s),null):null==this?void 0:this.get_context(o)}get_editor_index_at(e){let t=this.get_cell_at(e);return this.widget.content.widgets.findIndex((e=>t===e))}get_editor_index(e){let t=this.ce_editor_to_cell.get(e);return this.widget.content.widgets.findIndex((e=>t===e))}get_editor_wrapper(e){return this.ce_editor_to_cell.get(e).node}get_cell_at(e){let t=this.virtual_editor.virtual_document.get_editor_at_virtual_line(e);return this.ce_editor_to_cell.get(t)}}const ae={id:o+":NotebookAdapter",requires:[a,oe.INotebookTracker],activate(e,t,n){t.registerAdapterType({name:"notebook",tracker:n,adapter:re,entrypoint:"notebook-cell-context-menu",get_id:e=>e.content.id,context_menu:{selector:".jp-Notebook .jp-CodeCell .jp-Editor",rank_group:10+Number.EPSILON,rank_group_size:4,callback(e){e.add_context_separator(0)}}})},autoStart:!0};class le extends class{constructor(e){this.add_to_palette=!0,this.category="Language Server Protocol",this.adapter_manager=e.adapter_manager,this.app=e.app,this.palette=e.palette,this.tracker=e.tracker,this.suffix=e.suffix,this.entry_point=e.entry_point}get current_adapter(){return this.adapter_manager.currentAdapter}add(e){for(let t of e){let e=this.create_id(t);this.app.commands.addCommand(e,{execute:()=>this.execute(t),isEnabled:()=>this.is_enabled(t),isVisible:()=>this.is_visible(t),label:t.label,icon:t.icon}),this.should_attach(t)&&this.attach_command(t),this.add_to_palette&&this.palette.addItem({command:e,category:this.category})}}should_attach(e){return null==e.attach_to||e.attach_to.has(this.entry_point)}create_id(e){return"lsp:"+e.id+"-"+this.suffix}}{constructor(e){super(e),this.selector=e.selector,this.entry_point=e.entry_point,this.rank_group=e.rank_group,this.rank_group_size=e.rank_group_size,this.console=e.console,e.callback&&e.callback(this)}attach_command(e){this.app.contextMenu.addItem({selector:this.selector,command:this.create_id(e),rank:this.get_rank(e)})}add_context_separator(e){this.app.contextMenu.addItem({type:"separator",selector:this.selector,rank:this.rank_group+e})}execute(e){let t=this.get_context();t&&e.execute(t)}get is_context_menu_open(){return this.app.contextMenu.menu.isAttached}get is_widget_current(){return null!=this.tracker.currentWidget&&this.tracker.currentWidget===this.app.shell.currentWidget}is_enabled(){return this.is_context_menu_open?function(e){let t=e.get_position_from_context_menu();return!!t&&""!==e.virtual_editor.get_token_at(t).value}(this.current_adapter):this.is_widget_current}get_context(){var e;let t=null;if(this.is_context_menu_open)try{t=this.current_adapter.get_context_from_context_menu()}catch(e){this.console.warn("contextMenu is attached, but could not get the context",e),t=null}return null==t&&(t=null===(e=this.current_adapter)||void 0===e?void 0:e.context_from_active_document()),t}is_visible(e){var t;try{let n=this.get_context();return null!=n&&this.current_adapter&&(null===(t=n.connection)||void 0===t?void 0:t.isReady)&&e.is_enabled(n)}catch(e){return this.console.warn("is_visible failed",e),!1}}get_rank(e){if((void 0===e.is_rank_relative||e.is_rank_relative)&&void 0!==this.rank_group&&this.rank_group_size){let t=void 0!==e.rank?e.rank:0;return this.rank_group+t/this.rank_group_size}return null!=e.rank?e.rank:1/0}}var ce=n(5950),de=n(6271),he=n.n(de),ue=n(4929);function _e(e,t){return he().createElement("a",{href:e,target:"_blank",rel:"noopener noreferrer",className:"lsp-external-link"},t)}j()(ue.Z,{insert:"head",singleton:!1}),ue.Z.locals;const ge=he().createElement("div",null,he().createElement("p",null,"It appears that the required Jupyter server extension (",he().createElement("code",null,"jupyter-lsp"),") is not installed (or not enabled) in this environment."),he().createElement("h3",null,"What are the likely reasons?"),he().createElement("ul",null,he().createElement("li",null,"It might be that you just installed it and need to restart JupyterLab to make it available on startup."),he().createElement("li",null,"Alternatively, you may be using an older ",he().createElement("code",null,"notebook")," server instead of the new ",he().createElement("code",null,"jupyter_server"),"; please refer to the"," ",_e("https://jupyter-server.readthedocs.io/en/latest/operators/migrate-from-nbserver.html","migration guide")," or if you are a JupyterHub user please ensure that you start the JupyterLab using"," ",he().createElement("code",null,"jupyter_server")," and not the old ",he().createElement("code",null,"notebook"),", as documented in"," ",_e("https://github.com/jupyterhub/jupyterhub/pull/3329/files","this pull request"),"."),he().createElement("li",null,"There may be schema errors or language server errors preventing the extension from loading - please check the logs of JupyterLab (in the console where you execute ",he().createElement("code",null,"jupyter lab"))),he().createElement("h3",null,"How do I check if the extension is installed?"),he().createElement("p",null,"Please ensure that ",he().createElement("code",null,"jupyter server extension list")," includes jupyter-lsp and that it is enabled. If it is enabled please try to restart JupyterLab.")),pe=new ce.LabIcon({name:"lsp:codeWarning",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" width="24" viewBox="0 0 24 24">\n  <g class="jp-icon3 jp-icon-selectable" fill="#616161" shape-rendering="geometricPrecision">\n    <path d="M6.59 3.41L2 8l4.59 4.6L8 11.18 4.82 8 8 4.82 6.59 3.41m5.82 0L11 4.82 14.18 8 11 11.18l1.41 1.42L17 8l-4.59-4.59M16.95 12.05L10.9 22.5H23m-6.05-8.25l4.141 7.15h-8.283m3.592-4.95v2.2h1.1v-2.2m-1.1 3.3v1.1h1.1v-1.1"/>\n  </g>\n</svg>\n'}),me=new ce.LabIcon({name:"lsp:codeClock",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" width="24" viewBox="0 0 24 24">\n  <g class="jp-icon3 jp-icon-selectable" fill="#616161" shape-rendering="geometricPrecision">\n    <path d="M6.59 3.41L2 8l4.59 4.6L8 11.18 4.82 8 8 4.82 6.59 3.41m5.82 0L11 4.82 14.18 8 11 11.18l1.41 1.42L17 8l-4.59-4.59M18.093 21.608a3.998 3.998 0 004.015-4.015 3.998 3.998 0 00-4.015-4.016 3.998 3.998 0 00-4.016 4.016 3.998 3.998 0 004.016 4.015m0-8.923c2.676 0 4.907 2.23 4.907 4.908 0 2.676-2.23 4.907-4.907 4.907s-4.908-2.23-4.908-4.907 2.23-4.908 4.908-4.908m2.498 5.89l-.348.624-2.588-1.428v-2.632h.75v2.141z" />\n  </g>\n</svg>\n'}),fe=new ce.LabIcon({name:"lsp:codeCheck",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" width="24" viewBox="0 0 24 24">\n  <g class="jp-icon3 jp-icon-selectable" fill="#616161" shape-rendering="geometricPrecision">\n    <path d="M6.59,3.41L2,8L6.59,12.6L8,11.18L4.82,8L8,4.82L6.59,3.41M12.41,3.41L11,4.82L14.18,8L11,11.18L12.41,12.6L17,8L12.41,3.41M21.59,11.59L13.5,19.68L9.83,16L8.42,17.41L13.5,22.5L23,13L21.59,11.59Z" />\n  </g>\n</svg>\n'});function ve(e){e&&(e.scrollIntoView(),e.focus())}function we(e){let{document:t,adapter:n}=e,i=null;if(n.has_multiple_editors){let e=t.virtual_lines.get(0);e?i=n.get_editor_wrapper(e.editor):console.warn("Could not get first line of ",t)}let s=function(e,t,n=!0){return e.ancestry.map((e=>{if(!e.parent){let t=e.path;!e.has_lsp_supported_file&&t.endsWith(e.file_extension)&&(t=t.slice(0,-e.file_extension.length-1));const i=t;if(n){let e=t.split("/");e.length>2&&(t=e[0]+"/.../"+e[e.length-1])}return he().createElement("span",{key:e.uri,title:i},t)}if(!e.virtual_lines.size)return he().createElement("span",{key:e.uri},"Empty document");try{if(t.has_multiple_editors){let n=e.virtual_lines.get(0),i=e.virtual_lines.get(e.last_virtual_line-1),s=t.get_editor_index(n.editor),o=t.get_editor_index(i.editor),r=s===o?"cell "+(s+1):`cells: ${s+1}-${o+1}`;return he().createElement("span",{key:e.uri},e.language," (",r,")")}}catch(e){console.warn("LSP: could not display document cell location",e)}return he().createElement("span",{key:e.uri},e.language)}))}(t,n);return he().createElement("div",{className:"lsp-document-locator",onClick:()=>ve(i||null)},s)}var ye=f.Dialog.okButton;function be(e){let t=e.server.spec.languages.map(((e,t)=>he().createElement("li",{key:t},e)));return he().createElement("div",{className:"lsp-server-status"},he().createElement("h5",null,e.server.spec.display_name),he().createElement("ul",null,t))}class xe extends he().Component{constructor(e){super(e),this.handleClick=()=>{this.setState((e=>({isCollapsed:!e.isCollapsed})))},this.state={isCollapsed:e.startCollapsed||!1}}render(){const e=this.state.isCollapsed?ce.caretDownIcon:ce.caretUpIcon;return he().createElement("div",{className:"lsp-collapsible-list "+(this.state.isCollapsed?"lsp-collapsed":"")},he().createElement("h4",{onClick:this.handleClick},he().createElement(e.react,{tag:"span",className:"lsp-caret-icon"}),this.props.title,": ",this.props.list.length),he().createElement("div",null,this.props.list))}}class ke extends f.VDomRenderer{constructor(e){super(e),this.addClass("lsp-popover")}render(){var e;if(!(null===(e=this.model)||void 0===e?void 0:e.connection_manager))return null;const t=this.model.servers_available_not_in_use.map(((e,t)=>he().createElement(be,{key:t,server:e})));let n=new Array,i=-1;for(let[e,t]of this.model.documents_by_server.entries()){i+=1;let s=new Array;for(let[n,o]of t){let t=o.map(((e,t)=>{let n=this.model.connection_manager.connections.get(e.uri),i="";i=(null==n?void 0:n.isInitialized)?"initialized":(null==n?void 0:n.isConnected)?"connected":"not connected";const s="initialized"===i?ce.circleIcon:ce.circleEmptyIcon;return he().createElement("li",{key:t},he().createElement(we,{document:e,adapter:this.model.adapter}),he().createElement("span",{className:"lsp-document-status"},this.model.trans.__(i),he().createElement(s.react,{tag:"span",className:"lsp-document-status-icon",elementSize:"small"})))}));s.push(he().createElement("div",{key:i,className:"lsp-documents-by-language"},he().createElement("h5",null,n," ",he().createElement("span",{className:"lsp-language-server-name"},"(",e.spec.display_name,")")),he().createElement("ul",null,t)))}n.push(he().createElement("div",{key:i},s))}const s=this.model.missing_languages.map(((e,t)=>he().createElement("div",{key:t,className:"lsp-missing-server"},e)));return he().createElement("div",{className:"lsp-popover-content"},he().createElement("div",{className:"lsp-servers-menu"},he().createElement("h3",{className:"lsp-servers-title"},this.model.trans.__("LSP servers")),he().createElement("div",{className:"lsp-servers-lists"},t.length?he().createElement(xe,{key:"available",title:this.model.trans.__("Available"),list:t,startCollapsed:!0}):"",n.length?he().createElement(xe,{key:"running",title:this.model.trans.__("Running"),list:n}):"",s.length?he().createElement(xe,{key:"missing",title:this.model.trans.__("Missing"),list:s}):"")),he().createElement("div",{className:"lsp-popover-status"},this.model.trans.__("Documentation:")," ",he().createElement("a",{href:"https://jupyterlab-lsp.readthedocs.io/en/latest/Language%20Servers.html",target:"_blank",rel:"noreferrer"},this.model.trans.__("Language Servers"))))}}const Ce="jp-mod-selected";class Se extends f.VDomRenderer{constructor(e,t=!0,n){super(new Se.Model(e,n)),this.displayText=t,this._popup=null,this.handleClick=()=>{this._popup&&this._popup.dispose(),"no_server_extension"==this.model.status.status?(0,f.showDialog)({title:this.trans.__("LSP server extension not found"),body:ge,buttons:[ye({label:this.trans.__("OK")})]}).catch(console.warn):this._popup=(0,b.showPopup)({body:new ke(this.model),anchor:this,align:"left"})},this.addClass(b.interactiveItem),this.addClass("lsp-statusbar-item"),this.trans=n,this.title.caption=this.trans.__("LSP status"),this.interactiveStateObserver=new MutationObserver((()=>{const e=this.node.classList.contains(Ce);this.node.classList.contains(b.interactiveItem)?e&&this.removeClass(Ce):e||this.addClass(Ce)}))}onAfterAttach(e){super.onAfterAttach(e),this.interactiveStateObserver.observe(this.node,{attributes:!0,attributeFilter:["class"]})}onBeforeDetach(e){super.onBeforeDetach(e),this.interactiveStateObserver.disconnect()}render(){const{model:e}=this;return null==e?null:he().createElement(b.GroupItem,{spacing:this.displayText?2:0,title:e.long_message,onClick:this.handleClick,className:"lsp-status-group"},he().createElement(e.status_icon.react,{top:"2px",kind:"statusBar",title:this.trans.__("LSP Code Intelligence")}),this.displayText?he().createElement(b.TextItem,{source:e.short_message}):null,he().createElement(b.TextItem,{source:e.feature_message}))}}class Ee{constructor(e){this.options=e}createItem(e=!0){const t=new Se(this.options.adapter_manager,e,this.options.translator_bundle);return t.model.language_server_manager=this.options.language_server_manager,t.model.connection_manager=this.options.connection_manager,t}createNew(e,t){const n=this.createItem(!1);return n.addClass("jp-ToolbarButton"),e.toolbar.insertAfter("spacer","LSPStatus",n),n}}const Me={no_server_extension:"error",waiting:"inactive",initialized:"ready",initializing:"preparing",initialized_but_some_missing:"ready",connecting:"preparing"},je={no_server_extension:pe,waiting:me,initialized:fe,initializing:me,initialized_but_some_missing:pe,connecting:me},Ie={no_server_extension:"Server extension missing",waiting:"Waiting...",initialized:"Fully initialized",initialized_but_some_missing:"Initialized (additional servers needed)",initializing:"Initializing...",connecting:"Connecting..."};!function(e){class t extends f.VDomModel{constructor(e,t){super(),this.server_extension_status=null,this._onChange=()=>{this.stateChanged.emit(void 0)},this._adapter=null,this.trans=t,e.adapterChanged.connect(((e,t)=>{this.change_adapter(t)}),this),e.adapterDisposed.connect(((e,t)=>{this.adapter===t&&this.change_adapter(null)}),this)}get available_servers(){return this.language_server_manager.sessions}get supported_languages(){const e=new Set;for(let t of this.available_servers.values())for(let n of t.spec.languages)e.add(n.toLocaleLowerCase());return e}is_server_running(e,t){for(const t of this.detected_languages){const n=this.language_server_manager.getMatchingServers({language:t});if(n.length&&n[0]===e)return!0}}get documents_by_server(){var e;let t=new Map;if(!(null===(e=this.adapter)||void 0===e?void 0:e.virtual_editor))return t;let n=G(this.adapter.virtual_editor.virtual_document);for(let e of n.values()){let n=e.language.toLocaleLowerCase(),i=this._connection_manager.language_server_manager.getMatchingServers({language:e.language});if(0===i.length)continue;let s=this.language_server_manager.sessions.get(i[0]);t.has(s)||t.set(s,new Map);let o=t.get(s);o.has(n)||o.set(n,new Array),o.get(n).push(e)}return t}get servers_available_not_in_use(){return[...this.available_servers.entries()].filter((([e,t])=>!this.is_server_running(e,t))).map((([e,t])=>t))}get detected_languages(){var e;return(null===(e=this.adapter)||void 0===e?void 0:e.virtual_editor)?function(e){let t=G(e);return new Set([...t].map((e=>e.language.toLocaleLowerCase())))}(this.adapter.virtual_editor.virtual_document):new Set}get missing_languages(){return[...this.detected_languages].filter((e=>!this.supported_languages.has(e.toLocaleLowerCase())))}get status(){var e;let t;if(null===(e=this.adapter)||void 0===e?void 0:e.virtual_editor){let e=this.adapter.virtual_editor.virtual_document;const n=this._connection_manager.documents,i=G(e);t=new Map([...n].filter((([e,t])=>i.has(t))))}else t=new Map;let n=new Set,i=new Set,s=new Set,o=new Set,r=new Set;t.forEach(((e,t)=>{let a=this._connection_manager.connections.get(t);0!==this._connection_manager.language_server_manager.getMatchingServers({language:e.language}).length&&r.add(e),a?(o.add(e),a.isConnected&&n.add(e),a.isInitialized&&i.add(e)):s.add(e)}));let a,l=new Array;return this._connection_manager.connections.forEach(((e,t)=>{e.isConnected&&l.push(e)})),a=404===this.language_server_manager.statusCode?"no_server_extension":0===t.size?"waiting":i.size===t.size?"initialized":i.size===o.size&&t.size>r.size?"initialized_but_some_missing":n.size===o.size?"initializing":"connecting",{open_connections:l,connected_documents:n,initialized_documents:i,detected_documents:new Set([...t.values()]),status:a}}get status_icon(){return this.adapter?je[this.status.status].bindprops({className:"lsp-status-icon "+Me[this.status.status]}):ce.stopIcon}get short_message(){return this.adapter?this.trans.__(Ie[this.status.status]):this.trans.__("not initialized")}get feature_message(){var e,t;return(null===(t=null===(e=this.adapter)||void 0===e?void 0:e.status_message)||void 0===t?void 0:t.message)||""}get long_message(){if(!this.adapter)return this.trans.__("not initialized");let e=this.status,t="";if("waiting"===e.status)t=this.trans.__("Waiting for documents initialization...");else if("initialized"===e.status)t=this.trans._n("Fully connected & initialized (%2 virtual document)","Fully connected & initialized (%2 virtual document)",e.detected_documents.size,e.detected_documents.size);else if("initializing"===e.status){const n=new Set(e.detected_documents);for(let t of e.initialized_documents.values())n.delete(t);t=this.trans.__("Fully connected, but %2/%3 virtual document stuck uninitialized: %4","Fully connected, but %2/%3 virtual documents stuck uninitialized: %4",e.detected_documents.size,n.size,e.detected_documents.size,[...n].map((e=>e.id_path)).join(", "))}else{const n=new Set(e.detected_documents);for(let t of e.connected_documents.values())n.delete(t);t=this.trans.__("%2/%3 virtual document connected (%4 connections; waiting for: %5)","%2/%3 virtual documents connected (%4 connections; waiting for: %5)",e.detected_documents.size,e.connected_documents.size,e.detected_documents.size,e.open_connections.length,[...n].map((e=>e.id_path)).join(", "))}return t}get adapter(){return this._adapter}change_adapter(e){null!=this._adapter&&this._adapter.status_message.changed.disconnect(this._onChange),null!=e&&e.status_message.changed.connect(this._onChange),this._adapter=e}get connection_manager(){return this._connection_manager}set connection_manager(e){null!=this._connection_manager&&(this._connection_manager.connected.disconnect(this._onChange),this._connection_manager.initialized.connect(this._onChange),this._connection_manager.disconnected.disconnect(this._onChange),this._connection_manager.closed.disconnect(this._onChange),this._connection_manager.documents_changed.disconnect(this._onChange)),null!=e&&(e.connected.connect(this._onChange),e.initialized.connect(this._onChange),e.disconnected.connect(this._onChange),e.closed.connect(this._onChange),e.documents_changed.connect(this._onChange)),this._connection_manager=e}}e.Model=t}(Se||(Se={}));class Te{constructor(){this.registry={}}register(e,t){this.registry.hasOwnProperty(t)||(this.registry[t]=[]),this.registry[t].push(e)}}const Le={id:c.name,requires:[],activate:e=>new Te,provides:c,autoStart:!0};var Re,Ae,Pe,De,Oe,ze,$e=n(6606),Fe=n(9995),qe=n(5384);class He{constructor(e,t){this.settingRegistry=e,this.changed=new E.Signal(this),t in e.plugins?e.load(t).then((e=>{this.settings=e,this.changed.emit(),e.changed.connect((()=>{this.settings=e,this.changed.emit()}))})).catch(console.warn):console.warn(t+" settings schema could not be found and was not loaded")}get composite(){return this.settings.composite}set(e,t){this.settings.set(e,t).catch(console.warn)}}function Ne(e,t){return u(A.lsp_to_ce(e),t)}class We{constructor(e){this.feature=e.feature,this.virtual_editor=e.virtual_editor,this.virtual_document=e.virtual_document,this.connection=e.connection,this.status_message=e.status_message,this.adapter=e.adapter,this.console=this.adapter.console.scope(e.feature.name),this.trans=e.trans,this.editor_handlers=new Map,this.connection_handlers=new Map,this.wrapper_handlers=new Map,this.is_registered=!1}get settings(){return this.feature.settings}get lab_integration(){return this.feature.labIntegration}register(){for(let[e,t]of this.editor_handlers)this.virtual_editor.on(e,t);for(let[e,t]of this.connection_handlers)this.connection.on(e,t);this.wrapper=this.virtual_editor.getWrapperElement();for(let[e,t]of this.wrapper_handlers)this.wrapper.addEventListener(e,t);this.is_registered=!0}remove(){for(let[e,t]of this.editor_handlers)this.virtual_editor.off(e,t);this.editor_handlers.clear();for(let[e,t]of this.connection_handlers)this.connection.off(e,t);this.connection_handlers.clear();for(let[e,t]of this.wrapper_handlers)this.wrapper.removeEventListener(e,t);this.wrapper_handlers.clear()}range_to_editor_range(e,t){let n=A.lsp_to_cm(e.start),i=A.lsp_to_cm(e.end);if(null==t){let e=this.transform_virtual_position_to_root_position(n),i=this.virtual_editor.get_editor_at_root_position(e);t=this.virtual_editor.ce_editor_to_cm_editor.get(i)}return{start:this.virtual_document.transform_virtual_to_editor(n),end:this.virtual_document.transform_virtual_to_editor(i),editor:t}}position_from_mouse(e){return this.virtual_editor.coordsChar({left:e.clientX,top:e.clientY},"window")}transform_virtual_position_to_root_position(e){let t=this.virtual_document.virtual_lines.get(e.line).editor,n=this.virtual_document.transform_virtual_to_editor(e);return this.virtual_editor.transform_from_editor_to_root(t,n)}get_cm_editor(e){return this.virtual_editor.get_cm_editor(e)}get_language_at(e,t){return t.getModeAt(e).name}extract_last_character(e){if("paste"===e.origin){let t=e.text[e.text.length-1];return t[t.length-1]}return e.text[0][0]}highlight_range(e,t){return e.editor.getDoc().markText(e.start,e.end,{className:t})}is_whole_document_edit(e){let t=this.virtual_document.value,n=t.split("\n"),i=e.range,s=A.lsp_to_ce;return 0===u(s(i.start),n)&&u(s(i.end),n)===t.length}async apply_edit(e){let t,n,i=this.virtual_document.document_info.uri,s=e.documentChanges?e.documentChanges.map((e=>e)):function(e){let t=[];for(let n of Object.keys(e))t.push({textDocument:{uri:n},edits:e[n]});return t}(e.changes),o=0,r=[];for(let e of s){let s=e.textDocument.uri;if((0,O.Ei)(s,i)){let i;if(n=1===e.edits.length&&this.is_whole_document_edit(e.edits[0]),n)i=e.edits[0],o+=1;else{o=0;let t=this.virtual_document.value,n=t.split("\n"),s=new Map;for(let t of e.edits){let e=Ne(t.range.start,n);s.has(e)?console.warn("Edits should not overlap, ignoring an overlapping edit"):(s.set(e,t),o+=1)}let r=new O.Gl((()=>[])),a="",l=0,c=0,d=0,h=[...s.keys()].sort(((e,t)=>e-t));for(let e of h){let i=s.get(e),o=t.slice(l,e);for(let e=0;e<o.split("\n").length;e++)r.get_or_create(c).push(d),c+=1,d+=1;a+=o+i.newText;let h=Ne(i.range.end,n),u=t.slice(e,h);for(let e=0;e<i.newText.split("\n").length;e++)e<u.length&&(c+=1),d+=1,r.get_or_create(c).push(d);l=h}a+=t.slice(l,t.length),i={range:{start:{line:0,character:0},end:{line:n.length-1,character:n[n.length-1].length}},newText:a},console.assert(this.is_whole_document_edit(i))}t=this.apply_single_edit(i)}else r.push(`Workspace-wide edits not implemented: ${s} != ${i}`)}const a=s.every((e=>0===e.edits.length));return{appliedChanges:o,modifiedCells:t,wasGranular:!n&&!a,errors:r}}replace_fragment(e,t,n,i,s,o,r=!1){let a=this.virtual_document,l=e.split("\n").slice(n.line-s.line,i.line-s.line).join("\n");l.endsWith("\n")&&(l=l.slice(0,-1));let c=this.virtual_editor.ce_editor_to_cm_editor.get(t).getDoc(),d=c.getValue("\n"),{lines:h}=a.prepare_code_block({value:d,ce_editor:t}),_=h.join("\n");if(r){let t=A.cm_to_ce,n=u(t(s),h),i=u(t(o),h);l=_.slice(0,n)+e+_.slice(i)}if(_===l)return 0;let g=a.decode_code_block(l),p=c.getCursor();c.replaceRange(g,{line:0,ch:0},{line:i.line-n.line+1,ch:0});try{c.setCursor(p,p.ch,{scroll:!1})}catch(e){console.log("Could not place the cursor back",e)}return 1}afterChange(e,t){}apply_single_edit(e){let t=this.virtual_document,n=0,i=A.lsp_to_cm(e.range.start),s=A.lsp_to_cm(e.range.end),o=t.get_editor_at_virtual_line(i);if(o!==t.get_editor_at_virtual_line(s)){let r=o,a=i,l=Object.assign({},i),c=i.line,d=!1;for(;c<=s.line;){c++;let o=t.get_editor_at_virtual_line({line:c,ch:0});o===r?(l.line=c,l.ch=0,d=!1):(n+=this.replace_fragment(e.newText,r,a,l,i,s),d=!0,a={line:c,ch:0},l={line:c,ch:0},r=o)}d||(n+=this.replace_fragment(e.newText,r,a,l,i,s))}else n+=this.replace_fragment(e.newText,o,i,s,i,s);return n}}!function(e){e[e.Error=1]="Error",e[e.Warning=2]="Warning",e[e.Information=3]="Information",e[e.Hint=4]="Hint"}(Re||(Re={})),function(e){e[e.Text=1]="Text",e[e.Method=2]="Method",e[e.Function=3]="Function",e[e.Constructor=4]="Constructor",e[e.Field=5]="Field",e[e.Variable=6]="Variable",e[e.Class=7]="Class",e[e.Interface=8]="Interface",e[e.Module=9]="Module",e[e.Property=10]="Property",e[e.Unit=11]="Unit",e[e.Value=12]="Value",e[e.Enum=13]="Enum",e[e.Keyword=14]="Keyword",e[e.Snippet=15]="Snippet",e[e.Color=16]="Color",e[e.File=17]="File",e[e.Reference=18]="Reference",e[e.Folder=19]="Folder",e[e.EnumMember=20]="EnumMember",e[e.Constant=21]="Constant",e[e.Struct=22]="Struct",e[e.Event=23]="Event",e[e.Operator=24]="Operator",e[e.TypeParameter=25]="TypeParameter"}(Ae||(Ae={})),function(e){e[e.Text=1]="Text",e[e.Read=2]="Read",e[e.Write=3]="Write"}(Pe||(Pe={})),function(e){e[e.Invoked=1]="Invoked",e[e.TriggerCharacter=2]="TriggerCharacter",e[e.TriggerForIncompleteCompletions=3]="TriggerForIncompleteCompletions"}(De||(De={})),function(e){e[e.AutoInvoked=9999]="AutoInvoked"}(Oe||(Oe={})),function(e){e.abap="ABAP",e.bat="Windows Bat",e.bibtex="BibTeX",e.clojure="Clojure",e.coffeescript="Coffeescript",e.c="C",e.cpp="C++",e.csharp="C#",e.css="CSS",e.diff="Diff",e.dart="Dart",e.dockerfile="Dockerfile",e.elixir="Elixir",e.erlang="Erlang",e.fsharp="F#",e["git-commit"]="Git (commit)",e["git-rebase"]="Git (rebase)",e.go="Go",e.groovy="Groovy",e.handlebars="Handlebars",e.html="HTML",e.ini="Ini",e.java="Java",e.javascript="JavaScript",e.javascriptreact="JavaScript React",e.json="JSON",e.latex="LaTeX",e.less="Less",e.lua="Lua",e.makefile="Makefile",e.markdown="Markdown",e["objective-c"]="Objective-C",e["objective-cpp"]="Objective-C++",e.perl="Perl",e.perl6="Perl 6",e.php="PHP",e.powershell="Powershell",e.jade="Pug",e.python="Python",e.r="R",e.razor="Razor (cshtml)",e.ruby="Ruby",e.rust="Rust",e.scss="SCSS (syntax using curly brackets)",e.sass="SCSS (indented syntax)",e.scala="Scala",e.shaderlab="ShaderLab",e.shellscript="Shell Script (Bash)",e.sql="SQL",e.swift="Swift",e.typescript="TypeScript",e.typescriptreact="TypeScript React",e.tex="TeX",e.vb="Visual Basic",e.xml="XML",e.xsl="XSL",e.yaml="YAML"}(ze||(ze={}));var Ve=n(1674);class Ue{constructor(e,t,n,i,s){this.type=e,this.icon=t,this.match=n,this.connector=i,this.uri=s,this.label=n.label,this._setDocumentation(n.documentation),this._requested_resolution=!1,this._resolved=!1,this._detail=n.detail,this.self=this}get isDocumentationMarkdown(){return this._is_documentation_markdown}_setDocumentation(e){Ve.A_.is(e)?(this._documentation=e.value,this._is_documentation_markdown="markdown"===e.kind):(this._documentation=e,this._is_documentation_markdown=!1)}get insertText(){return this._currentInsertText||this.match.insertText||this.match.label}set insertText(e){this._currentInsertText=e}get sortText(){return this.match.sortText||this.match.label}get filterText(){return this.match.filterText}supportsResolution(){return this.connector.get_connection(this.uri).isCompletionResolveProvider()}get detail(){return this._detail}needsResolution(){return!this.documentation&&!this._resolved&&!this._requested_resolution&&this.supportsResolution()}isResolved(){return this._resolved}resolve(){if(this._resolved)return Promise.resolve(this);if(!this.supportsResolution())return Promise.resolve(this);if(this._requested_resolution)return(0,O.EU)((()=>this._resolved),100,50).then((()=>this));const e=this.connector.get_connection(this.uri);return this._requested_resolution=!0,e.getCompletionResolve(this.match).then((e=>{if(null===e)return e;this._setDocumentation(e.documentation),this._detail=e.detail,this._resolved=!0}))}get documentation(){return this.connector.should_show_documentation&&this._documentation?this._documentation:null}get deprecated(){return this.match.deprecated?this.match.deprecated:this.match.tags&&this.match.tags.some((e=>e==Ve.we.Deprecated))}}var Be=$e.CompletionHandler.ICompletionItemsResponseType;class Ze{constructor(e){if(this.options=e,this.isDisposed=!1,this.responseType=Be,this._editor=e.editor,this._connections=e.connections,this.virtual_editor=e.virtual_editor,this._context_connector=new $e.ContextConnector({editor:e.editor}),e.session){let t={editor:e.editor,session:e.session};this._kernel_connector=new $e.KernelConnector(t),this._kernel_and_context_connector=new $e.CompletionConnector(t)}this.lab_integration=e.labIntegration,this.console=e.console}get kernel_completions_first(){return this.options.settings.composite.kernelCompletionsFirst}get use_lsp_completions(){return-1==this.options.settings.composite.disableCompletionsFrom.indexOf("LSP")}get use_kernel_completions(){return-1==this.options.settings.composite.disableCompletionsFrom.indexOf("Kernel")}get suppress_continuous_hinting_in(){return this.options.settings.composite.suppressContinuousHintingIn}get suppress_trigger_character_in(){return this.options.settings.composite.suppressTriggerCharacterIn}get should_show_documentation(){return this.options.settings.composite.showDocumentation}dispose(){this.isDisposed||(this._connections=null,this.virtual_editor=null,this._context_connector=null,this._kernel_connector=null,this._kernel_and_context_connector=null,this.options=null,this._editor=null,this.isDisposed=!0)}get _has_kernel(){var e;return null!=(null===(e=this.options.session)||void 0===e?void 0:e.kernel)}get _is_kernel_idle(){var e,t;return"idle"==(null===(t=null===(e=this.options.session)||void 0===e?void 0:e.kernel)||void 0===t?void 0:t.status)}get _should_wait_for_busy_kernel(){return this.lab_integration.settings.composite.waitForBusyKernel}async _kernel_language(){return(await this.options.session.kernel.info).language_info.name}get _kernel_timeout(){return this.lab_integration.settings.composite.kernelResponseTimeout}get fallback_connector(){return this._kernel_and_context_connector?this._kernel_and_context_connector:this._context_connector}transform_from_editor_to_root(e){let t=A.ce_to_cm(e);return this.virtual_editor.transform_from_editor_to_root(this._editor,t)}async fetch(e){let t=this._editor;const n=t.getCursorPosition(),i=t.getTokenForPosition(n);if(this.trigger_kind==Oe.AutoInvoked){if(-1!==this.suppress_continuous_hinting_in.indexOf(i.type))return void this.console.debug("Suppressing completer auto-invoke in",i.type)}else if(this.trigger_kind==De.TriggerCharacter&&-1!==this.suppress_trigger_character_in.indexOf(i.type))return void this.console.debug("Suppressing completer auto-invoke in",i.type);const s=t.getPositionAt(i.offset),o=t.getPositionAt(i.offset+i.value.length);let r=n.column-s.column-1;const a=i.value[n.column-s.column-1];let l=this.transform_from_editor_to_root(s),c=this.transform_from_editor_to_root(o),d=this.transform_from_editor_to_root(n),h=this.virtual_editor,u=h.document_at_root_position(l),_=h.root_position_to_virtual_position(l),g=h.root_position_to_virtual_position(c),p=h.root_position_to_virtual_position(d);const m=this.use_lsp_completions?this.fetch_lsp(i,a,_,g,p,u,r):Promise.resolve(null);let f=null;try{const t=this._kernel_timeout;if(this.use_kernel_completions&&this._kernel_connector&&this._has_kernel&&(this._is_kernel_idle||this._should_wait_for_busy_kernel)&&0!=t){const n=await this._kernel_language();if(u.language===n){let n,i=this._kernel_connector.fetch(e);n=-1==t?i:Promise.race([i,new Promise((e=>setTimeout((()=>e({start:null,end:null,matches:[],metadata:null})),t)))]),f=Promise.all([n.catch((e=>e)),m.catch((e=>e))]).then((([e,t])=>{let n=[];return null!=e&&n.push(this.transform_reply(e)),null!=t&&n.push(t),this.merge_replies(n,this._editor)}))}}f||(f=m.catch((t=>(this.console.warn("hint failed",t),this.fallback_connector.fetch(e).then(this.transform_reply)))))}catch(t){this.console.warn("kernel completions failed",t),f=this.fallback_connector.fetch(e).then(this.transform_reply)}return this.console.debug("All promises set up and ready."),f.then((e=>(e=this.suppress_if_needed(e,i,n),this.items=e.items,this.trigger_kind=De.Invoked,e)))}get_connection(e){return this._connections.get(e)}async fetch_lsp(e,t,n,i,s,o,r){let a=this.get_connection(o.uri);this.console.debug("Fetching"),this.console.debug("Token:",e,n,i);const l=this.trigger_kind==Oe.AutoInvoked?De.Invoked:this.trigger_kind;let c=await a.getCompletion(s,{start:n,end:i,text:e.value},o.document_info,!1,t,l)||[];this.console.debug("Transforming");let d=e.value.slice(0,r+1),h=!0,u=[];c.forEach((t=>{let n=t.kind?Ae[t.kind]:"",i=new Ue(n,this.icon_for(n),t,this,o.uri),s=t.insertText?t.insertText:t.label;s.toLowerCase().startsWith(d.toLowerCase())&&(h=!1,d!==e.value&&s.toLowerCase().startsWith(e.value.toLowerCase())&&(d=e.value)),u.push(i)})),this.console.debug("Transformed");let _=e.value.length;h&&_>d.length&&(_=d.length);let g={start:e.offset+(h?_:0),end:e.offset+d.length,items:u,source:{name:"LSP",priority:2}};return g.start>g.end&&console.warn("Response contains start beyond end; this should not happen!",g),g}icon_for(e){if(this.options.settings.composite.theme)return void 0===e&&(e=qe.OC),this.options.themeManager.get_icon(e)||void 0}transform_reply(e){let t;this.console.log("Transforming kernel reply:",e);const n=(e.metadata||{})._jupyter_types_experimental;return t=n?n.map((e=>({label:e.text,insertText:e.text,type:"<unknown>"===e.type?void 0:e.type,icon:this.icon_for(e.type),sortText:this.kernel_completions_first?"a":"z"}))):e.matches.map((e=>({label:e,insertText:e,sortText:this.kernel_completions_first?"a":"z"}))),{start:e.start,end:e.end,source:{name:"Kernel",priority:1,fallbackIcon:this.icon_for("Kernel")},items:t}}merge_replies(e,t){this.console.debug("Merging completions:",e),(e=e.filter((e=>e instanceof Error?(this.console.warn(`Caught ${e.source.name} completions error`,e),!1):!!e.items.length))).sort(((e,t)=>t.source.priority-e.source.priority)),this.console.debug("Sorted replies:",e);const n=Math.min(...e.map((e=>e.end))),i=Math.min(...e.map((e=>e.start))),s=Math.max(...e.map((e=>e.start)));if(i!=s){const n=t.getCursorPosition(),i=t.getLine(n.line);e=e.map((e=>{if(e.start==s)return e;let t=i.substring(e.start,s);return this.console.debug(`Removing ${e.source.name} prefix: `,t),Object.assign(Object.assign({},e),{items:e.items.map((e=>(e.insertText=e.insertText.startsWith(t)?e.insertText.substr(t.length):e.insertText,e)))})}))}const o=new Set,r=new Array;for(const t of e)t.items.forEach((e=>{let n=e.insertText.trim();if(o.has(n))return;o.add(n);let i=e;i.source=t.source,i.icon||(i.icon=t.source.fallbackIcon),r.push(i)}));return this.console.debug("Merged: ",r),{start:s,end:n,source:null,items:r}}list(e){return Promise.resolve(void 0)}remove(e){return Promise.resolve(void 0)}save(e,t){return Promise.resolve(void 0)}suppress_if_needed(e,t,n){if(!this._editor.hasFocus())return this.console.debug("Ignoring completion response: the corresponding editor lost focus"),{start:e.start,end:e.end,items:[]};const i=this._editor.getCursorPosition();return n.line!=i.line||i.column<n.column?(this.console.debug("Ignoring completion response: cursor has receded or changed line"),{start:e.start,end:e.end,items:[]}):this.trigger_kind==Oe.AutoInvoked&&(e.start==e.end||1===e.items.length&&e.items[0].insertText===t.value)?{start:e.start,end:e.end,items:[]}:e}}var Ke=n(9850);function Je(e){let t=document.createElement("span");return t.textContent=e,t.innerHTML}class Ge extends $e.CompleterModel{constructor(e={}){super(),this.settings=Object.assign(Object.assign({},Ge.defaultOptions),e)}completionItems(){let e=this.query;this.query="";let t=super.completionItems();return this.query=e,this._sortAndFilter(e,t)}setCompletionItems(e){super.setCompletionItems(e)}_markFragment(e){return`<mark>${e}</mark>`}getFilterText(e){return this.getHighlightableLabelRegion(e)}getHighlightableLabelRegion(e){const t=e.label.indexOf("(");return t>-1?e.label.substring(0,t):e.label}_sortAndFilter(e,t){let n=[];for(let i of t){let t,s,o=null,r=e.toLowerCase();if(e?(o=this.getFilterText(i),s=this.settings.caseSensitive?Ke.StringExt.matchSumOfSquares(o,e):Ke.StringExt.matchSumOfSquares(o.toLowerCase(),r),t=!!s,this.settings.includePerfectMatches||(t=t&&o!=e)):t=!0,t){let t,r,a;if(e){let n=Je(this.getHighlightableLabelRegion(i));t=n==o?s:Ke.StringExt.matchSumOfSquares(n,e)}t?(r=Ke.StringExt.highlight(Je(i.label),t.indices,this._markFragment).join(""),a=t.score):(r=Je(i.label),a=0);const l=Object.create(Object.getPrototypeOf(i),Object.getOwnPropertyDescriptors(i));l.label=r,l.insertText=i.insertText?i.insertText:i.label,n.push({item:l,score:a})}}return n.sort(this.compareMatches),n.map((e=>e.item))}compareMatches(e,t){var n,i,s;const o=e.score-t.score;return 0!==o?o:null!==(s=null===(n=e.item.insertText)||void 0===n?void 0:n.localeCompare(null!==(i=t.item.insertText)&&void 0!==i?i:""))&&void 0!==s?s:0}}!function(e){e.defaultOptions={caseSensitive:!0,includePerfectMatches:!0}}(Ge||(Ge={}));class Xe extends Ge{getFilterText(e){return e.filterText?e.filterText:super.getFilterText(e)}compareMatches(e,t){const n=e.score-t.score;return 0!==n?n:e.item.sortText.localeCompare(t.item.sortText)}}class Ye extends $e.Completer.Renderer{constructor(e){super(),this.options=e,this.ITEM_PLACEHOLDER_CLASS="lsp-detail-placeholder",this.EXTRA_INFO_CLASS="jp-Completer-typeExtended",this.activeChanged=new E.Signal(this),this.itemShown=new E.Signal(this),this.elementToItem=new WeakMap,this.wasActivated=new WeakMap,this.visibilityObserver=new IntersectionObserver((e=>{e.forEach((e=>{if(!e.isIntersecting)return;let t=e.target,n=this.elementToItem.get(t);this.itemShown.emit({item:n,element:t})}))}),{threshold:.25}),this.activityObserver=new MutationObserver((e=>{e.forEach((e=>{let t=e.target;if(!(t instanceof HTMLLIElement))return;let n=!this.wasActivated.get(t);if(t.classList.contains("jp-mod-active")){if(n){this.wasActivated.set(t,!0);let e=this.elementToItem.get(t);this.activeChanged.emit({item:e,element:t})}}else this.wasActivated.set(t,!1)}))}))}getExtraInfo(e){var t,n,i,s,o,r;const a=this.options.integrator.settings.composite.labelExtra;switch(a){case"detail":return null==e?void 0:e.detail;case"type":return null===(n=null===(t=null==e?void 0:e.type)||void 0===t?void 0:t.toLowerCase)||void 0===n?void 0:n.call(t);case"source":return null===(i=null==e?void 0:e.source)||void 0===i?void 0:i.name;case"auto":return[null==e?void 0:e.detail,null===(o=null===(s=null==e?void 0:e.type)||void 0===s?void 0:s.toLowerCase)||void 0===o?void 0:o.call(s),null===(r=null==e?void 0:e.source)||void 0===r?void 0:r.name].filter((e=>!!e))[0];default:this.options.console.warn("labelExtra does not match any of the expected values",a)}}updateExtraInfo(e,t){const n=this.getExtraInfo(e);n&&(t.getElementsByClassName(this.EXTRA_INFO_CLASS)[0].textContent=n)}createCompletionItemNode(e,t){const n=super.createCompletionItemNode(e,t),i=e.self;return i?(i.element=n,this.elementToItem.set(n,i),this.activityObserver.observe(n,{attributes:!0,attributeFilter:["class"]}),this.visibilityObserver.observe(n),this.updateExtraInfo(i,n)):this.updateExtraInfo(e,n),n}createDocumentationNode(e){if(e.isDocumentationMarkdown){let t=e.documentation;return this.options.markdownRenderer.renderModel({data:{"text/markdown":t},trusted:!1,metadata:{},setData(e){}}).then((()=>{this.options.latexTypesetter&&t.includes("$")&&this.options.latexTypesetter.typeset(this.options.markdownRenderer.node)})).catch(this.options.console.warn),this.options.markdownRenderer.node}{let t=document.createElement("pre");return t.textContent=e.documentation,t}}}const Qe=".jp-Completer-docpanel",et="lsp-completer-placeholder";class tt extends We{get settings(){return super.settings}get completionCharacters(){return null!=this._completionCharacters&&this._completionCharacters.length||(this._completionCharacters=this.connection.getLanguageCompletionCharacters()),this._completionCharacters}afterChange(e){let t=this.extract_last_character(e);if(this.completionCharacters.indexOf(t)>-1)return this.virtual_editor.console.log("Will invoke completer after",t),void this.feature.labIntegration.invoke_completer(De.TriggerCharacter).catch(this.console.warn);e.text&&1==e.text[0].length&&this.settings.composite.continuousHinting&&this.feature.labIntegration.invoke_completer(Oe.AutoInvoked).catch(this.console.warn)}}class nt{constructor(e,t,n,i,s,o,r){this.app=e,this.completionManager=t,this.settings=n,this.adapterManager=i,this.completionThemeManager=s,this.console=o,this.renderMimeRegistry=r,this.current_adapter=null;const a=this.renderMimeRegistry.createRenderer("text/markdown");this.renderer=new Ye({integrator:this,markdownRenderer:a,latexTypesetter:this.renderMimeRegistry.latexTypesetter,console:o.scope("renderer")}),this.renderer.activeChanged.connect(this.active_completion_changed,this),this.renderer.itemShown.connect(this.resolve_and_update,this),i.adapterChanged.connect(this.swap_adapter,this),n.changed.connect((()=>{s.set_theme(this.settings.composite.theme),s.set_icons_overrides(this.settings.composite.typesMap),this.current_completion_handler&&(this.model.settings.caseSensitive=this.settings.composite.caseSensitive,this.model.settings.includePerfectMatches=this.settings.composite.includePerfectMatches)}))}fetchDocumentation(e){e&&e.resolve().then((t=>{this.set_doc_panel_placeholder(!1),null!==t&&this.refresh_doc_panel(e)})).catch((e=>{this.set_doc_panel_placeholder(!1),console.warn(e)}))}active_completion_changed(e,t){let{item:n}=t;if(!n.supportsResolution())return void(n.isDocumentationMarkdown&&this.refresh_doc_panel(n));n.needsResolution()?(this.set_doc_panel_placeholder(!0),this.fetchDocumentation(n)):n.isResolved()&&this.refresh_doc_panel(n);const i=this.current_index,s=this.current_items;if(i-1>=0){const e=s[i-1];this.resolve_and_update_from_item(null==e?void 0:e.self)}if(i+1<s.length){const e=s[i+1];this.resolve_and_update_from_item(null==e?void 0:e.self)}}resolve_and_update_from_item(e){e&&this.resolve_and_update(this.renderer,{item:e,element:e.element})}resolve_and_update(e,t){let{item:n,element:i}=t;n.supportsResolution()?n.isResolved()?this.renderer.updateExtraInfo(n,i):n.resolve().then((e=>{this.renderer.updateExtraInfo(n,i)})).catch((e=>{this.console.warn(e)})):this.renderer.updateExtraInfo(n,i)}swap_adapter(e,t){this.current_adapter&&(this.current_adapter.activeEditorChanged.disconnect(this.set_connector,this),this.current_adapter.adapterConnected.disconnect(this.connect_completion,this)),this.current_adapter=t,this.current_adapter.isConnected&&(this.connect_completion(this.current_adapter),this.set_connector(t,{editor:t.activeEditor})),this.current_adapter.activeEditorChanged.connect(this.set_connector,this),this.current_adapter.adapterConnected.connect(this.connect_completion,this)}connect_completion(e,t){let n=e.activeEditor;if(null==n)return;this.set_completion_connector(e,n),this.current_completion_handler=this.completionManager.register({connector:this.current_completion_connector,editor:n,parent:e.widget},this.renderer);let i=this.completer;i.addClass("lsp-completer"),i.model=new Xe({caseSensitive:this.settings.composite.caseSensitive,includePerfectMatches:this.settings.composite.includePerfectMatches})}get completer(){return this.current_completion_handler.completer}get model(){return this.completer.model}invoke_completer(e){let t;return this.current_completion_connector.trigger_kind=e,t=this.adapterManager.currentAdapter instanceof re?"completer:invoke-notebook":"completer:invoke-file",this.app.commands.execute(t).catch((()=>{this.current_completion_connector.trigger_kind=De.Invoked}))}set_connector(e,t){this.current_completion_handler||this.connect_completion(e),this.set_completion_connector(e,t.editor),this.current_completion_handler.editor=t.editor,this.current_completion_handler.connector=this.current_completion_connector}get current_items(){return this.model.completionItems()}get current_index(){return this.current_completion_handler.completer._activeIndex}refresh_doc_panel(e){let t=this.current_completion_handler.completer;const n=this.current_items[this.current_index];if(!e||n.insertText!=e.insertText)return;const i=t.node.querySelector(Qe);if(i.classList.remove(et),e.documentation){i.textContent="";const t=this.renderer.createDocumentationNode(e);i.appendChild(t),i.setAttribute("style","")}else i.setAttribute("style","display: none")}set_doc_panel_placeholder(e){const t=this.current_completion_handler.completer.node.querySelector(Qe);e?(t.setAttribute("style",""),t.classList.add(et)):t.classList.contains(et)&&(t.setAttribute("style","display: none"),t.classList.remove(et))}set_completion_connector(e,t){var n,i;this.current_completion_connector&&delete this.current_completion_connector,this.current_completion_connector=new Ze({editor:t,themeManager:this.completionThemeManager,connections:this.current_adapter.connection_manager.connections,virtual_editor:this.current_adapter.virtual_editor,settings:this.settings,labIntegration:this,session:null===(i=null===(n=this.current_adapter.widget)||void 0===n?void 0:n.sessionContext)||void 0===i?void 0:i.session,console:this.console})}}new ce.LabIcon({name:"lsp:completion",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" width="24" viewBox="0 0 24 24">\n  <g class="jp-icon3 jp-icon-selectable" fill="#616161" shape-rendering="geometricPrecision">\n     <path d="M5,9.5L7.5,14H2.5L5,9.5M3,4H7V8H3V4M5,20A2,2 0 0,0 7,18A2,2 0 0,0 5,16A2,2 0 0,0 3,18A2,2 0 0,0 5,20M9,5V7H21V5H9M9,19H21V17H9V19M9,13H21V11H9V13Z" />\n  </g>\n</svg>\n'});const it=o+":completion",st={id:it,requires:[r,y.ISettingRegistry,$e.ICompletionManager,a,qe.kZ,d,Fe.IRenderMimeRegistry],autoStart:!0,activate:(e,t,n,i,s,o,r,a)=>{const l=new He(n,it),c=new nt(e,i,l,s,o,r.scope("CompletionLab"),a);t.register({feature:{editorIntegrationFactory:new Map([["CodeMirrorEditor",tt]]),id:it,name:"LSP Completion",labIntegration:c,settings:l}})}};var ot=n(6510),rt=n(7981),at=n(8337);const lt='<svg xmlns="http://www.w3.org/2000/svg" width="24" viewBox="0 0 24 24">\n  <g class="jp-icon3 jp-icon-selectable" fill="#616161" shape-rendering="geometricPrecision">\n    <path d="M12 14a2 2 0 012 2 2 2 0 01-2 2 2 2 0 01-2-2 2 2 0 012-2m11.46-5.14l-1.59 6.89L15 14.16l3.8-2.38A7.972 7.972 0 0012 8c-3.95 0-7.23 2.86-7.88 6.63l-1.97-.35C2.96 9.58 7.06 6 12 6c3.58 0 6.73 1.89 8.5 4.72l2.96-1.86z"/>\n  </g>\n</svg>\n',ct=new ce.LabIcon({name:"lsp:jump-to",svgstr:lt}),dt=new ce.LabIcon({name:"lsp:jump-back",svgstr:lt.replace("jp-icon3","lsp-icon-flip-x jp-icon3")}),ht=o+":jump_to";let ut;class _t extends We{get jumper(){return this.feature.labIntegration.jumper}get settings(){return super.settings}get modifierKey(){return this.settings.composite.modifierKey}register(){this.editor_handlers.set("mousedown",((e,t)=>{let n=this.position_from_mouse(t),i=e.document_at_root_position(n),s=e.root_position_to_virtual_position(n);const{button:o}=t;0===o&&(0,O.nE)(t,this.modifierKey)&&(this.connection.getDefinition(s,i.document_info,!1).then((e=>{this.handle_jump(e,i.document_info.uri).catch(this.console.warn)})).catch(this.console.warn),t.preventDefault(),t.stopPropagation())})),super.register()}get_uri_and_range(e){if(null==e)return;const t=Array.isArray(e)?e:[e];if(0===t.length)return;this.console.log("Will jump to the first of suggested locations:",t);const n=t[0];return"targetUri"in n?{uri:n.targetUri,range:n.targetRange}:"uri"in n?{uri:n.uri,range:n.range}:void 0}async handle_jump(e,t){const n=this.get_uri_and_range(e);if(!n)return void this.status_message.set(ut.__("No jump targets found"),2e3);let{uri:i,range:s}=n,o=A.lsp_to_cm(s.start);if((0,O.Ei)(i,t)){let e=this.adapter.get_editor_index_at(o),t=this.virtual_editor.transform_virtual_to_editor(o),n=A.cm_to_ce(t);this.console.log(`Jumping to ${e}th editor of ${i}`),this.console.log("Jump target within editor:",n);let s=this.adapter.widget.context.path;this.jumper.global_jump({line:n.line,column:t.ch,editor_index:e,is_symlink:!1,contents_path:s})}else{let e=A.cm_to_ce(o);this.console.log("Jumping to external file: "+i),this.console.log("Jump target (source location):",e);let t={editor_index:0,line:e.line,column:e.column},n=(0,O.lj)(i);null==n&&i.startsWith("file://")&&(n=decodeURI(i.slice(7)));try{return await this.jumper.document_manager.services.contents.get(n,{content:!1}),void this.jumper.global_jump(Object.assign(Object.assign({contents_path:n},t),{is_symlink:!1}))}catch(e){this.console.warn(e)}this.jumper.global_jump(Object.assign(Object.assign({contents_path:D.URLExt.join(".lsp_symlink",n)},t),{is_symlink:!0}))}}}class gt{constructor(e,t,n,i,s){this.settings=e,this.adapterManager=t,this.jumpers=new Map,null!==s&&s.widgetAdded.connect(((e,t)=>{if(t.content.editor instanceof rt.CodeMirrorEditor){let e=new at.FileEditorJumper(t,i);this.jumpers.set(t.id,e)}})),n.widgetAdded.connect((async(e,t)=>{let n=new at.NotebookJumper(t,i);this.jumpers.set(t.id,n)}))}get jumper(){let e=this.adapterManager.currentAdapter.widget.id;return this.jumpers.get(e)}}const pt=e=>[{id:"jump-to-definition",execute:async({connection:e,virtual_position:t,document:n,features:i})=>{const s=i.get(ht),o=await e.getDefinition(t,n.document_info,!1);await s.handle_jump(o,n.document_info.uri)},is_enabled:({connection:e})=>e.isDefinitionSupported(),label:e.__("Jump to definition"),icon:ct},{id:"jump-back",execute:async({connection:e,virtual_position:t,document:n,features:i})=>{i.get(ht).jumper.global_jump_back()},is_enabled:({connection:e})=>e.isDefinitionSupported(),label:e.__("Jump back"),icon:dt,attach_to:new Set}],mt={id:ht,requires:[r,y.ISettingRegistry,a,oe.INotebookTracker,v.IDocumentManager,x.ITranslator],optional:[R.IEditorTracker],autoStart:!0,activate:(e,t,n,i,s,o,r,a)=>{const l=new He(n,ht);ut=r.load("jupyterlab-lsp");let c=new gt(l,i,s,o,a);t.register({feature:{editorIntegrationFactory:new Map([["CodeMirrorEditor",_t]]),commands:pt(ut),id:ht,name:"Jump to definition",labIntegration:c,settings:l}})}};var ft=n(2372);j()(ft.Z,{insert:"head",singleton:!1}),ft.Z.locals;class vt extends Map{get all(){return[].concat.apply([],this.values())}}class wt{constructor(e){this.options=e,this.is_visible=!0}render_cell(e,t){return this.options.render_cell(e,t)}sort(e,t){return this.options.sort(e,t)}get name(){return this.options.name}is_available(e){return null==this.options.is_available||this.options.is_available(e)}render_header(e){return he().createElement(yt,{name:this.name,listing:e,key:this.name})}}function yt(e){const t=e.name===e.listing.sort_key,n=t&&1!==e.listing.sort_direction?ce.caretDownIcon:ce.caretUpIcon;return he().createElement("th",{key:e.name,onClick:()=>e.listing.sort(e.name),className:t?"lsp-sorted-header":null},he().createElement("div",null,he().createElement("label",null,xt.__(e.name)),he().createElement(n.react,{tag:"span",className:"lsp-sort-icon"})))}class bt extends f.VDomRenderer{constructor(){super(...arguments),this.sort_key="Severity",this.sort_direction=1,this.columns=[new wt({name:"Virtual Document",render_cell:(e,t)=>he().createElement("td",{key:0},he().createElement(we,{document:e.document,adapter:t.adapter})),sort:(e,t)=>e.document.id_path.localeCompare(t.document.id_path),is_available:e=>e.db.size>1}),new wt({name:"Message",render_cell:e=>{let t=function(e){let t=e.message,n=""+e.code;return null!=e.code&&""!==e.code&&t.startsWith(n+"")?t.slice(n.length).trim():t}(e.data.diagnostic);return he().createElement("td",{key:1},t)},sort:(e,t)=>e.data.diagnostic.message.localeCompare(t.data.diagnostic.message)}),new wt({name:"Code",render_cell:e=>he().createElement("td",{key:2},e.data.diagnostic.code),sort:(e,t)=>(e.data.diagnostic.code+"").localeCompare(t.data.diagnostic.source+"")}),new wt({name:"Severity",render_cell:e=>he().createElement("td",{key:3},xt.__(Re[e.data.diagnostic.severity||1])),sort:(e,t)=>e.data.diagnostic.severity>t.data.diagnostic.severity?1:-1}),new wt({name:"Source",render_cell:e=>he().createElement("td",{key:4},e.data.diagnostic.source),sort:(e,t)=>e.data.diagnostic.source.localeCompare(t.data.diagnostic.source)}),new wt({name:"Cell",render_cell:e=>he().createElement("td",{key:5},e.cell_number),sort:(e,t)=>e.cell_number>t.cell_number||e.data.range.start.line>t.data.range.start.line||e.data.range.start.ch>t.data.range.start.ch?1:-1,is_available:e=>e.adapter.has_multiple_editors}),new wt({name:"Line:Ch",render_cell:e=>he().createElement("td",{key:6},e.data.range.start.line,":",e.data.range.start.ch),sort:(e,t)=>e.data.range.start.line>t.data.range.start.line||e.data.range.start.ch>t.data.range.start.ch?1:-1})]}sort(e){e===this.sort_key?this.sort_direction=-1*this.sort_direction:(this.sort_key=e,this.sort_direction=1),this.update()}render(){let e=this.model.diagnostics;const t=this.model.virtual_editor,n=this.model.adapter;if(!e||null==t)return he().createElement("div",null,xt.__("No issues detected, great job!"));let i=Array.from(e).map((([e,i])=>e.isDisposed?[]:i.map(((i,s)=>{let o=null;if(n.has_multiple_editors){let{index:e}=t.find_editor(i.editor);o=e+1}return{data:i,key:e.uri+","+s,document:e,cell_number:o,editor:t}})))),s=[].concat.apply([],i);this._diagnostics=new Map(s.map((e=>[e.key,e])));let o=this.columns.filter((e=>e.name===this.sort_key))[0],r=o.sort.bind(o),a=s.sort(((e,t)=>r(e,t)*this.sort_direction)),l={db:e,editor:t,adapter:n},c=this.columns.filter((e=>e.is_available(l)&&e.is_visible)),d=a.map((e=>{let t=c.map((t=>t.render_cell(e,l)));return he().createElement("tr",{key:e.key,"data-key":e.key,onClick:()=>{this.jump_to(e)}},t)})),h=c.map((e=>e.render_header(this)));return he().createElement("table",{className:"lsp-diagnostics-listing"},he().createElement("thead",null,he().createElement("tr",null,h)),he().createElement("tbody",null,d))}get_diagnostic(e){if(this._diagnostics.has(e))return this._diagnostics.get(e);console.warn("Could not find the diagnostics row with key",e)}jump_to(e){const t=e.data.editor;ve(t.getWrapperElement()),t.getDoc().setCursor(e.data.range.start),t.focus()}}let xt;!function(e){class t extends f.VDomModel{constructor(e){super(),xt=e}}e.Model=t}(bt||(bt={}));const kt=new ce.LabIcon({name:"lsp:diagnostics",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" width="24" viewBox="0 0 24 24">\n  <g class="jp-icon3 jp-icon-selectable" fill="#616161" shape-rendering="geometricPrecision">\n    <path d="M19 8c.56 0 1 .43 1 1a1 1 0 01-1 1c-.57 0-1-.45-1-1 0-.57.43-1 1-1M2 2v9c0 2.96 2.19 5.5 5.14 5.91.62 3.01 3.28 5.09 6.36 5.09a6.5 6.5 0 006.5-6.5v-3.69c1.16-.42 2-1.52 2-2.81a3 3 0 00-3-3 3 3 0 00-3 3c0 1.29.84 2.4 2 2.81v3.6c0 2.5-2 4.5-4.5 4.5-2 0-3.68-1.21-4.28-3.01C12 16.3 14 13.8 14 11V2h-4v3h2v6a4 4 0 01-4 4 4 4 0 01-4-4V5h2V2H2z"/>\n  </g>\n</svg>\n'}),Ct="lsp-set-column-visibility",St="lsp-jump-to-diagnostic",Et="lsp-copy-diagnostic",Mt="lsp-ignore-diagnostic-code",jt="lsp-ignore-diagnostic-message",It=new class{constructor(){this._content=null,this._widget=null,this.is_registered=!1}get widget(){return null!=this._widget&&null!=this._widget.content.model||(this._widget&&!this._widget.isDisposed&&this._widget.dispose(),this._widget=this.init_widget()),this._widget}get content(){return this.widget.content}init_widget(){var e;this._content=new bt(new bt.Model(this.trans)),this._content.model.diagnostics=new vt,this._content.addClass("lsp-diagnostics-panel-content");const t=new f.MainAreaWidget({content:this._content});return t.id="lsp-diagnostics-panel",t.title.label=null===(e=this.trans)||void 0===e?void 0:e.__("Diagnostics Panel"),t.title.closable=!0,t.title.icon=kt,t}update(){this.widget.isAttached&&this.widget.content.update()}register(e){const t=this.widget;let n=e=>{for(let n of t.content.columns)if(n.name===e)return n},i=new ot.Menu({commands:e.commands});i.title.label=this.trans.__("Panel columns"),e.commands.addCommand(Ct,{execute:e=>{let i=n(e.name);i.is_visible=!i.is_visible,t.update()},label:e=>this.trans.__(""+e.name),isToggled:e=>n(e.name).is_visible});for(let e of t.content.columns)i.addItem({command:Ct,args:{name:e.name}});e.contextMenu.addItem({selector:".lsp-diagnostics-listing th",submenu:i,type:"submenu"});let s=new ot.Menu({commands:e.commands});s.title.label=this.trans.__("Ignore diagnostics like this");let o=()=>{let t=e.contextMenuHitTest((e=>"tr"==e.tagName.toLowerCase()));if(t)return this.widget.content.get_diagnostic(t.dataset.key)};s.addItem({command:Mt}),s.addItem({command:jt}),e.commands.addCommand(Mt,{execute:()=>{const e=o().data.diagnostic;let t=this.content.model.settings.composite.ignoreCodes;this.content.model.settings.set("ignoreCodes",[...t,e.code]),this.feature.refreshDiagnostics()},isVisible:()=>{const e=o();return!!e&&!!e.data.diagnostic.code},label:()=>{const e=o();if(!e)return"";const t=e.data.diagnostic;return this.trans.__('Ignore diagnostics with "%1" code',t.code)}}),e.commands.addCommand(jt,{execute:()=>{const e=o().data.diagnostic;let t=this.content.model.settings.composite.ignoreMessagesPatterns;var n;this.content.model.settings.set("ignoreMessagesPatterns",[...t,(n=e.message,n.replace(/[.*+\-?^${}()|[\]\\]/g,"\\$&"))]),this.feature.refreshDiagnostics()},isVisible:()=>{const e=o();return!!e&&!!e.data.diagnostic.message},label:()=>{const e=o();if(!e)return"";const t=e.data.diagnostic;return this.trans.__('Ignore diagnostics with "%1" message',t.message)}}),e.commands.addCommand(St,{execute:()=>{const e=o();this.widget.content.jump_to(e)},label:this.trans.__("Jump to location"),icon:ct}),e.commands.addCommand(Et,{execute:()=>{const e=o();if(!e)return;const t=e.data.diagnostic.message;navigator.clipboard.writeText(t).then((()=>{this.content.model.status_message.set(this.trans.__('Successfully copied "%1" to clipboard',t))})).catch((()=>{console.warn("Could not copy with clipboard.writeText interface, falling back"),window.prompt(this.trans.__("Your browser protects clipboard from write operations; please copy the message manually"),t)}))},label:this.trans.__("Copy diagnostics' message"),icon:ce.copyIcon}),e.contextMenu.addItem({selector:".lsp-diagnostics-listing tbody tr",command:Et}),e.contextMenu.addItem({selector:".lsp-diagnostics-listing tbody tr",command:St}),e.contextMenu.addItem({selector:".lsp-diagnostics-listing tbody tr",submenu:s,type:"submenu"}),this.is_registered=!0}},Tt=new WeakMap;class Lt extends We{constructor(){super(...arguments),this.marked_diagnostics=new Map,this.switchDiagnosticsPanelSource=()=>{It.trans=this.adapter.trans,It.content.model.virtual_editor===this.virtual_editor&&It.content.model.diagnostics==this.diagnostics_db||(It.content.model.diagnostics=this.diagnostics_db,It.content.model.virtual_editor=this.virtual_editor,It.content.model.adapter=this.adapter,It.content.model.settings=this.settings,It.content.model.status_message=this.status_message,It.feature=this,It.update())},this.handleDiagnostic=(e,t)=>{if((0,O.Ei)(t.uri,this.virtual_document.document_info.uri)&&0!==this.virtual_document.last_virtual_line)try{this.last_response=t,this.setDiagnostics(t),It.update()}catch(e){this.console.warn(e)}}}get settings(){return super.settings}register(){this.connection.serverNotifications["textDocument/publishDiagnostics"].connect(this.handleDiagnostic),this.wrapper_handlers.set("focusin",this.switchDiagnosticsPanelSource),this.unique_editor_ids=new O.Gl((()=>this.unique_editor_ids.size)),this.settings.changed.connect(this.refreshDiagnostics,this),this.adapter.adapterConnected.connect((()=>this.switchDiagnosticsPanelSource())),this.virtual_document.foreign_document_closed.connect(((e,t)=>{this.clearDocumentDiagnostics(t.foreign_document)})),super.register()}clearDocumentDiagnostics(e){this.diagnostics_db.set(e,[])}get diagnostics_db(){return Tt.has(this.virtual_editor)||Tt.set(this.virtual_editor,new vt),Tt.get(this.virtual_editor)}collapse_overlapping_diagnostics(e){const t=new Map,n=new Map;e.forEach((e=>{let i=e.range,s=function(e){return e.start.line+","+e.start.character+","+e.end.line+","+e.end.character}(i);t.set(s,i),n.has(s)?n.get(s).push(e):n.set(s,[e])}));let i=new Map;return n.forEach(((e,n)=>{let s=t.get(n);i.set(s,e)})),i}get defaultSeverity(){return Re[this.settings.composite.defaultSeverity]}filterDiagnostics(e){const t=new Set(this.settings.composite.ignoreCodes),n=this.settings.composite.ignoreMessagesPatterns.map((e=>new RegExp(e)));return e.filter((e=>{let i=e.code;if(null!=i&&t.has(i.toString()))return!1;let s=e.message;return!s||!n.some((e=>e.test(s)))}))}setDiagnostics(e){let t=[];const n=new Set;this.collapse_overlapping_diagnostics(this.filterDiagnostics(e.diagnostics)).forEach(((i,s)=>{const o=A.lsp_to_cm(s.start),r=A.lsp_to_cm(s.end),a=this.virtual_document.last_virtual_line-this.virtual_document.blank_lines_between_cells;if(o.line>a)return void this.console.log(`Out of range diagnostic (${o.line} line > ${a}) was skipped `,i);{let e=this.virtual_document.last_line;if(o.line==a&&o.ch>e.length)return void this.console.log(`Out of range diagnostic (${o.ch} character > ${e.length} at line ${a}) was skipped `,i)}let l;try{let e=this.transform_virtual_position_to_root_position(o);l=this.virtual_editor.document_at_root_position(e)}catch(t){return void this.console.warn("Could not place inspections from "+e.uri," inspections: ",i,"error: ",t)}if(this.virtual_document!==l)return void this.console.log("Ignoring inspections from "+e.uri,` (this region is covered by a another virtual document: ${l.uri})`," inspections: ",i);if(-1!==l.virtual_lines.get(o.line).skip_inspect.indexOf(l.id_path))return void this.console.log("Ignoring inspections silenced for this document:",i);let c=i.map((e=>e.severity||this.defaultSeverity)).sort()[0];const d=Re[c];let h,u=l.get_editor_at_virtual_line(o),_=this.virtual_editor.ce_editor_to_cm_editor.get(u),g=l.transform_virtual_to_editor(o);try{h=l.transform_virtual_to_editor(r)}catch(e){this.console.warn("Malformed range for diagnostic",r),h=Object.assign(Object.assign({},g),{ch:g.ch+1})}let p={start:g,end:h},m=JSON.stringify({diagnostics:i.map((e=>[e.severity,e.message,e.code,e.source,e.relatedInformation])),range:p,editor:this.unique_editor_ids.get(_)});for(let e of i)t.push({diagnostic:e,editor:_,range:p});if(n.add(m),!this.marked_diagnostics.has(m)){let e,t={title:i.map((e=>e.message+(e.source?" ("+e.source+")":""))).join("\n"),className:"cm-lsp-diagnostic cm-lsp-diagnostic-"+d};try{e=_.getDoc().markText(g,h,t)}catch(e){return void this.console.warn("Marking inspection (diagnostic text) failed:",i,e)}this.marked_diagnostics.set(m,e)}})),this.remove_unused_diagnostic_markers(n),this.diagnostics_db.set(this.virtual_document,t)}refreshDiagnostics(){this.last_response&&this.setDiagnostics(this.last_response),It.update()}remove_unused_diagnostic_markers(e){this.marked_diagnostics.forEach(((t,n)=>{e.has(n)||(this.marked_diagnostics.delete(n),t.clear())}))}remove(){this.settings.changed.disconnect(this.refreshDiagnostics,this),this.remove_unused_diagnostic_markers(new Set),this.diagnostics_db.clear(),Tt.delete(this.virtual_editor),this.unique_editor_ids.clear(),It.content.model.virtual_editor===this.virtual_editor&&(It.content.model.virtual_editor=null,It.content.model.diagnostics=null,It.content.model.adapter=null),It.update(),super.remove()}}const Rt=o+":diagnostics",At=e=>[{id:"show-diagnostics-panel",execute:({app:e,features:t,adapter:n})=>{t.get(Rt).switchDiagnosticsPanelSource(),It.is_registered||It.register(e);const i=It.widget;i.isAttached||e.shell.add(i,"main",{ref:n.widget_id,mode:"split-bottom"}),e.shell.activateById(i.id)},is_enabled:e=>"JupyterLab Classic"!=e.app.name,label:e.__("Show diagnostics panel"),rank:3,icon:kt}],Pt={id:Rt,requires:[r,y.ISettingRegistry,x.ITranslator],autoStart:!0,activate:(e,t,n,i)=>{const s=new He(n,Rt),o=i.load("jupyterlab-lsp");t.register({feature:{editorIntegrationFactory:new Map([["CodeMirrorEditor",Lt]]),id:Rt,name:"LSP Diagnostics",settings:s,commands:At(o)}})}};var Dt=n(7458);const Ot=new ce.LabIcon({name:"lsp:highlight",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" width="24" viewBox="0 0 24 24">\n  <g class="jp-icon3 jp-icon-selectable" fill="#616161" shape-rendering="geometricPrecision">\n    <path d="M18.5 1.15c-.53 0-1.04.19-1.43.58l-5.81 5.82 5.65 5.65 5.82-5.81c.77-.78.77-2.04 0-2.83l-2.84-2.83c-.39-.39-.89-.58-1.39-.58M10.3 8.5l-5.96 5.96c-.78.78-.78 2.04.02 2.85C3.14 18.54 1.9 19.77.67 21h5.66l.86-.86c.78.76 2.03.75 2.81-.02l5.95-5.96"/>\n  </g>\n</svg>\n'}),zt=new ce.LabIcon({name:"lsp:highlight-type",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" width="24" viewBox="0 0 24 24">\n  <g class="jp-icon3 jp-icon-selectable" fill="#616161" shape-rendering="geometricPrecision">\n    <path d="M18.5 1.15c-.53 0-1.04.19-1.43.58l-5.81 5.82 5.65 5.65 5.82-5.81c.77-.78.77-2.04 0-2.83l-2.84-2.83c-.39-.39-.89-.58-1.39-.58M10.3 8.5l-5.96 5.96c-.78.78-.78 2.04.02 2.85C3.14 18.54 1.9 19.77.67 21h5.66l.86-.86c.78.76 2.03.75 2.81-.02l5.95-5.96M18 16v2h2v8h2v-8h2v-2h-6z"/>\n  </g>\n</svg>\n'}),$t=e=>[{id:"highlight-references",execute:({connection:e,virtual_position:t,document:n})=>e.getReferences(t,n.document_info),is_enabled:({connection:e})=>e.isReferencesSupported(),label:e.__("Highlight references"),icon:Ot},{id:"highlight-type-definition",execute:({connection:e,virtual_position:t,document:n})=>e.getTypeDefinition(t,n.document_info),is_enabled:({connection:e})=>e.isTypeDefinitionSupported(),label:e.__("Highlight type definition"),icon:zt}];class Ft extends We{constructor(){super(...arguments),this.highlight_markers=[],this.onBlur=()=>{this.settings.composite.removeOnBlur?(this.clear_markers(),this.last_token=null):this.onCursorActivity().catch(console.warn)},this.handleHighlight=e=>{if(this.clear_markers(),e)for(let t of e){let e=this.range_to_editor_range(t.range),n=t.kind?"cm-lsp-highlight-"+Pe[t.kind]:"",i=this.highlight_range(e,"cm-lsp-highlight "+n);this.highlight_markers.push(i)}},this.on_cursor_activity=async()=>(this.sent_version=this.virtual_document.document_info.version,await this.connection.getDocumentHighlights(this.virtual_position,this.virtual_document.document_info,!1)),this.onCursorActivity=async()=>{var e,t;if(!(null===(t=null===(e=this.virtual_editor)||void 0===e?void 0:e.virtual_document)||void 0===t?void 0:t.document_info))return;let n;await this.virtual_editor.virtual_document.update_manager.update_done;try{n=this.virtual_editor.getDoc().getCursor("start")}catch(e){return void this.console.warn("no root position available")}if(null==n)return void this.console.warn("no root position available");const i=this.virtual_editor.get_token_at(n);if(this.last_token&&i.value===this.last_token.value&&""!==i.value)return void this.console.log("not requesting highlights (token did not change)",i);let s;try{s=this.virtual_editor.document_at_root_position(n)}catch(e){return void this.console.warn("Could not obtain virtual document from position",n)}if(s===this.virtual_document)try{let e=this.virtual_editor.root_position_to_virtual_position(n);this.virtual_position=e,Promise.all([this.debounced_get_highlight.invoke(),async()=>{this.clear_markers(),this.last_token=null}]).then((([t])=>{if(this.virtual_document.isDisposed)return;let n=this.virtual_document.document_info.version;n===this.sent_version?e===this.virtual_position?(this.handleHighlight(t),this.last_token=i):this.console.log("skipping highlights response: cursor moved since it was requested"):this.console.log("skipping highlights response delayed by "+(n-this.sent_version)+" document versions")})).catch(this.console.warn)}catch(e){this.console.warn("Could not get highlights:",e)}}}get settings(){return super.settings}register(){this.debounced_get_highlight=this.create_debouncer(),this.settings.changed.connect((()=>{this.debounced_get_highlight=this.create_debouncer()})),this.editor_handlers.set("cursorActivity",this.onCursorActivity),this.editor_handlers.set("blur",this.onBlur),this.editor_handlers.set("focus",this.onCursorActivity),super.register()}remove(){this.handleHighlight=null,this.onCursorActivity=null,this.clear_markers(),super.remove()}clear_markers(){for(let e of this.highlight_markers)e.clear();this.highlight_markers=[]}create_debouncer(){return new Dt.dx(this.on_cursor_activity,this.settings.composite.debouncerDelay)}}const qt=o+":highlights",Ht={id:qt,requires:[r,y.ISettingRegistry,x.ITranslator],autoStart:!0,activate:(e,t,n,i)=>{const s=new He(n,qt),o=i.load("jupyterlab-lsp");t.register({feature:{editorIntegrationFactory:new Map([["CodeMirrorEditor",Ft]]),id:qt,name:"LSP Highlights",settings:s,commands:$t(o)}})}};var Nt=n(6011);class Wt extends Nt.Tooltip{constructor(e){super(e),this.position=e.position,this.movetoLineEnd=e.moveToLineEnd}_setGeometry(){const e=this._editor,t=null==this.position?e.getCursorPosition():this.position,n=e.getOffsetAt(t),i=e.getLine(t.line);if(!i)return;let s;if(this.movetoLineEnd){const t=i.substring(0,n).split(/\W+/),o=t[t.length-1],r=o?n-o.length:n;s=e.getPositionAt(r)}else s=t;if(!s)return;const o=e.getCoordinateForPosition(s),r=window.getComputedStyle(this.node),a=parseInt(r.paddingLeft,10)||0;f.HoverBox.setGeometry({anchor:o,host:e.host,maxHeight:250,minHeight:20,node:this.node,offset:{horizontal:-1*a},privilege:"below",style:r})}}class Vt{constructor(e){this.rendermime_registry=e,this.currentTooltip=null}create(e){this.remove();let{markup:t,position:n,adapter:i}=e,s=i.widget;const o="plaintext"===t.kind?{"text/plain":t.value}:{"text/markdown":t.value},r=new Wt({anchor:s.content,bundle:o,editor:e.ce_editor,rendermime:this.rendermime_registry,position:A.cm_to_ce(n),moveToLineEnd:!1});return r.addClass(e.className),ot.Widget.attach(r,document.body),this.currentTooltip=r,r}remove(){null!==this.currentTooltip&&this.currentTooltip.dispose()}}new ce.LabIcon({name:"lsp:hover",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" width="24" viewBox="0 0 24 24">\n  <g class="jp-icon3 jp-icon-selectable" fill="#616161" shape-rendering="geometricPrecision">\n    <path d="M11 18h2v-2h-2v2m1-12a4 4 0 00-4 4h2a2 2 0 012-2 2 2 0 012 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5a4 4 0 00-4-4M5 3h14a2 2 0 012 2v14a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2z"/>\n  </g>\n</svg>\n'});class Ut{constructor(e){this.maxSize=e,this._data=[]}get data(){return this._data}store(e){this._data.length>=this.maxSize&&this._data.shift(),this._data.push(e)}clean(){this._data=[]}}function Bt(e){return"string"==typeof e?{kind:"plaintext",value:e}:{kind:"markdown",value:"```"+e.language+"\n"+e.value+"\n```"}}class Zt extends We{constructor(){super(...arguments),this.onKeyDown=e=>{if((0,O.nE)(e,this.modifierKey)&&void 0!==this.last_hover_character){if(this.tooltip&&this.tooltip.isVisible&&!this.tooltip.isDisposed)return;const t=this.virtual_editor.document_at_root_position(this.last_hover_character);let n=this.restore_from_cache(t,this.virtual_position);if(null==n)return;e.stopPropagation(),this.handleResponse(n,this.last_hover_character,!0)}},this.onMouseLeave=e=>{this.remove_range_highlight(),this.maybeHideTooltip(e.relatedTarget)},this.on_hover=async()=>{var e;if(!this.connection.isReady||!(null===(e=this.connection.serverCapabilities)||void 0===e?void 0:e.hoverProvider))return;let t=this.virtual_position;return await this.connection.clientRequests["textDocument/hover"].request({textDocument:{uri:this.virtual_document.document_info.uri},position:{line:t.line,character:t.ch}})},this.handleResponse=(e,t,n)=>{let i=e.response;if(this.last_hover_response!=i&&(this.remove_range_highlight(),this.hover_marker=this.highlight_range(e.editor_range,"cm-lsp-hover-available")),this.last_hover_response=i,n){this.lab_integration.tooltip.remove();const n=Zt.get_markup_for_hover(i);let s=this.virtual_editor.root_position_to_editor(t);return this.tooltip=this.lab_integration.tooltip.create({markup:n,position:s,ce_editor:e.ce_editor,adapter:this.adapter,className:"lsp-hover"}),!0}return!1},this.updateUnderlineAndTooltip=e=>{try{return this._updateUnderlineAndTooltip(e)}catch(e){"Cell not found in cell_line_map"!==e.message&&"Cannot read property 'string' of undefined"!==e.message&&this.console.warn(e)}},this.remove_range_highlight=()=>{this.hover_marker&&(this.hover_marker.clear(),this.hover_marker=null,this.last_hover_response=void 0,this.last_hover_character=void 0)}}get modifierKey(){return this.settings.composite.modifierKey}get lab_integration(){return super.lab_integration}get settings(){return super.settings}restore_from_cache(e,t){const{line:n,ch:i}=t,s=this.cache.data.filter((t=>{if(t.document!==e)return!1;let s=t.response.range;return n>=s.start.line&&n<=s.end.line&&(n!=s.start.line||i>=s.start.character)&&(n!=s.end.line||i<=s.end.character)}));return s.length>1&&this.console.warn("Potential hover cache malfunction: ",t,s),0!=s.length?s[0]:null}register(){this.cache=new Ut(this.settings.composite.cacheSize),this.wrapper_handlers.set("mousemove",(e=>{this.updateUnderlineAndTooltip(e).then((t=>{t||this.maybeHideTooltip(e.target)})).catch(this.console.warn)})),this.wrapper_handlers.set("mouseleave",this.onMouseLeave),this.wrapper_handlers.set("keydown",this.onKeyDown),this.editor_handlers.set("keydown",((e,t)=>this.onKeyDown(t))),this.debounced_get_hover=this.create_throttler(),this.settings.changed.connect((()=>{this.cache.maxSize=this.settings.composite.cacheSize,this.debounced_get_hover=this.create_throttler()})),super.register()}maybeHideTooltip(e){void 0!==this.tooltip&&e!==this.tooltip.node&&this.tooltip.dispose()}create_throttler(){return new Dt.eD(this.on_hover,{limit:this.settings.composite.throttlerDelay,edge:"trailing"})}afterChange(e,t){super.afterChange(e,t),this.cache.clean(),this.last_hover_character=void 0,this.remove_range_highlight()}static get_markup_for_hover(e){let t=e.contents;if("string"==typeof t&&(t=[t]),!Array.isArray(t))return t;let n=t.map(Bt);return n.every((e=>"plaintext"==e.kind))?{kind:"plaintext",value:n.map((e=>e.value)).join("\n")}:{kind:"markdown",value:n.map((e=>e.value)).join("\n\n")}}is_token_empty(e){return 0===e.string.length}is_event_inside_visible(e){return null!=e.target.closest(".CodeMirror-sizer")}is_useful_response(e){return e&&e.contents&&!(Array.isArray(e.contents)&&0===e.contents.length)}async _updateUnderlineAndTooltip(e){if(e.target.classList.contains("CodeMirror-line"))return void this.remove_range_highlight();const t=(0,O.nE)(e,this.modifierKey);let n=this.position_from_mouse(e);if(null==n)return void this.remove_range_highlight();let i=this.virtual_editor.getTokenAt(n),s=this.virtual_editor.document_at_root_position(n);if(!this.is_token_empty(i)&&s===this.virtual_document&&this.is_event_inside_visible(e)){if(function(e,t){return t&&e.line===t.line&&e.ch===t.ch}(n,this.last_hover_character))return!0;{let e=this.virtual_editor.root_position_to_virtual_position(n);this.virtual_position=e,this.last_hover_character=n;let o=this.restore_from_cache(s,e);if(null==o){let e=await this.debounced_get_hover.invoke();if(!this.is_useful_response(e))return void this.remove_range_highlight();{let t=this.virtual_editor.get_editor_at_root_position(n),r=this.virtual_editor.ce_editor_to_cm_editor.get(t),a=this.get_editor_range(e,n,i,r);o={response:this.add_range_if_needed(e,a,t),document:s,editor_range:a,ce_editor:t},this.cache.store(o)}}return this.handleResponse(o,n,t)}}this.remove_range_highlight()}remove(){this.cache.clean(),this.remove_range_highlight(),this.debounced_get_hover.dispose(),super.remove(),this.debounced_get_hover=null,this.remove_range_highlight=null,this.handleResponse=null,this.on_hover=null}get_editor_range(e,t,n,i){if(void 0!==e.range)return this.range_to_editor_range(e.range,i);let s={line:t.line,ch:n.start},o={line:t.line,ch:n.end};return{start:this.virtual_editor.root_position_to_editor(s),end:this.virtual_editor.root_position_to_editor(o),editor:i}}add_range_if_needed(e,t,n){return void 0!==e.range?e:Object.assign(Object.assign({},e),{range:{start:A.cm_to_lsp(this.virtual_editor.root_position_to_virtual_position(this.virtual_editor.transform_from_editor_to_root(n,t.start))),end:A.cm_to_lsp(this.virtual_editor.root_position_to_virtual_position(this.virtual_editor.transform_from_editor_to_root(n,t.end)))}})}}class Kt{constructor(e,t,n){this.tooltip=new Vt(n)}}const Jt=o+":hover",Gt={id:Jt,requires:[r,y.ISettingRegistry,Fe.IRenderMimeRegistry],autoStart:!0,activate:(e,t,n,i)=>{const s=new He(n,Jt),o=new Kt(e,s,i);t.register({feature:{editorIntegrationFactory:new Map([["CodeMirrorEditor",Zt]]),id:Jt,name:"LSP Hover tooltip",labIntegration:o,settings:s}})}},Xt=new ce.LabIcon({name:"lsp:rename",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" width="24" viewBox="0 0 24 24">\n  <g class="jp-icon3 jp-icon-selectable" fill="#616161" shape-rendering="geometricPrecision">\n    <path d="M17 7h5v10h-5v2a1 1 0 001 1h2v2h-2.5c-.55 0-1.5-.45-1.5-1 0 .55-.95 1-1.5 1H12v-2h2a1 1 0 001-1V5a1 1 0 00-1-1h-2V2h2.5c.55 0 1.5.45 1.5 1 0-.55.95-1 1.5-1H20v2h-2a1 1 0 00-1 1v2M2 7h11v2H4v6h9v2H2V7m18 8V9h-3v6h3z"/>\n  </g>\n</svg>\n'}),Yt=o+":rename",Qt=e=>[{id:"rename-symbol",execute:async({editor:t,connection:n,virtual_position:i,document:s,features:o})=>{const r=o.get(Yt);r.setTrans(e);let a=r.transform_virtual_position_to_root_position(i),l=t.get_token_at(a).value;const c=await f.InputDialog.getText({title:e.__("Rename to"),text:l,okLabel:e.__("Rename"),cancelLabel:e.__("Cancel")});try{if(1!=c.button.accept)return;let t=c.value;r.setStatus(e.__("Renaming %1 to %2...",l,t),2e3);const o=await n.rename(i,s.document_info,t,!1);await r.handleRename(o,l,t)}catch(n){(n=>{let i="";if(o.has(Rt)){let e=o.get(Rt);i=en.ux_workaround_for_rope_limitation(n,e,t,r)}i||(i=e.__("Rename failed: %1",n)),r.setStatus(i,7500)})(n)}},is_enabled:({connection:e})=>e.isRenameSupported(),label:e.__("Rename symbol"),icon:Xt}];class en extends We{setTrans(e){this.trans=e}setStatus(e,t){return this.status_message.set(e,t)}async handleRename(e,t,n){let i;try{i=await this.apply_edit(e)}catch(e){return this.status_message.set(this.trans.__("Rename failed: %1",e)),i}try{let e;const s=this.trans.__("%1 to %2",t,n);e=0===i.appliedChanges?this.trans.__("Could not rename %1 - consult the language server documentation",s):i.wasGranular?this.trans._n("Renamed %2 in %3 place","Renamed %2 in %3 places",i.appliedChanges,s,i.appliedChanges):this.adapter.has_multiple_editors?this.trans._n("Renamed %2 in %3 cell","Renamed %2 in %3 cells",i.modifiedCells,s,i.modifiedCells):this.trans.__("Renamed %1",s),0!==i.errors.length&&(e+=this.trans.__(" with errors: %1",i.errors)),this.status_message.set(e,5e3)}catch(e){this.console.warn(e)}return i}static ux_workaround_for_rope_limitation(e,t,n,i){let s=!1;try{s=e.message.includes("IndexError")}catch(e){return null}if(!s)return null;let o=(t.diagnostics_db.all||[]).filter((e=>e.diagnostic.message.includes("invalid syntax")||e.diagnostic.message.includes("SyntaxError")||e.diagnostic.message.includes("IndentationError")));if(0===o.length)return null;let r=[...new Set(o.map((e=>{let t=e.diagnostic.message,s=e.range.start;if(i.adapter.has_multiple_editors){let{index:o}=n.find_editor(e.editor),r=o+1;return i.trans.__("%1 in cell %2 at line %3",t,r,s.line)}return i.trans.__("%1 at line %2",t,s.line)})))].join(", ");return i.trans.__("Syntax error(s) prevent rename: %1",r)}}const tn={id:Yt,requires:[r,y.ISettingRegistry,x.ITranslator],autoStart:!0,activate:(e,t,n,i)=>{const s=(i||x.nullTranslator).load("jupyterlab-lsp"),o=new He(n,Yt);t.register({feature:{editorIntegrationFactory:new Map([["CodeMirrorEditor",en]]),id:Yt,name:"LSP Rename",settings:o,commands:Qt(s)}})}};class nn extends We{get lab_integration(){return super.lab_integration}get_markup_for_signature_help(e,t){let n=new Array;return e.signatures.forEach((e=>{let i=this.markdown_from_signature(e,t);n.push(i)})),{kind:"markdown",value:n.join("\n\n")}}markdown_from_signature(e,t){let n="```"+t+"\n"+e.label+"\n```";if(e.documentation)if(n+="\n","string"==typeof e.documentation||"plaintext"===e.documentation.kind){let i=!1;for(let s of e.documentation.toString().split("\n"))s.trim()!==e.label.trim()&&(s.startsWith(">>>")?(i&&(n+="```\n\n",i=!1),s="```"+t+"\n"+s.substr(3)+"\n```"):i||(n+="```\n",i=!0),n+=s+"\n");i&&(n+="```")}else"markdown"!==e.documentation.kind&&this.console.warn("Unknown MarkupContent kind:",e.documentation.kind),n+=e.documentation.value;return n}handleSignature(e,t){if(this.lab_integration.tooltip.remove(),this.console.log("Signature received",e),!this.signature_character||!e||!e.signatures.length)return void this.console.debug("Ignoring signature response: cursor lost or response empty");let n=t;(t.line!=n.line||n.ch<t.ch)&&this.console.debug("Ignoring signature response: cursor has receded or changed line");let i=this.get_cm_editor(n);if(!i.hasFocus())return void this.console.debug("Ignoring signature response: the corresponding editor lost focus");let s=this.virtual_editor.root_position_to_editor(n),o=this.get_language_at(s,i),r=this.get_markup_for_signature_help(e,o);this.console.log("Signature will be shown",o,r,n),this.lab_integration.tooltip.create({markup:r,position:s,ce_editor:this.virtual_editor.find_ce_editor(i),adapter:this.adapter,className:"lsp-signature-help"})}get signatureCharacters(){var e;return(null===(e=this._signatureCharacters)||void 0===e?void 0:e.length)||(this._signatureCharacters=this.connection.getLanguageSignatureCharacters()),this._signatureCharacters}afterChange(e,t){let n=this.extract_last_character(e);if(-1===this.signatureCharacters.indexOf(n))return;this.signature_character=t;let i=this.virtual_editor.root_position_to_virtual_position(t);this.console.log("Signature will be requested for",i),this.connection.getSignatureHelp(i,this.virtual_document.document_info,!1).then((e=>this.handleSignature(e,t))).catch(this.console.warn)}}class sn{constructor(e,t,n){this.tooltip=new Vt(n)}}const on=o+":signature",rn={id:on,requires:[r,y.ISettingRegistry,Fe.IRenderMimeRegistry],autoStart:!0,activate:(e,t,n,i)=>{const s=new He(n,on),o=new sn(e,s,i);t.register({feature:{editorIntegrationFactory:new Map([["CodeMirrorEditor",nn]]),id:on,name:"LSP Function signature",labIntegration:o,settings:s}})}};var an=n(8186);new ce.LabIcon({name:"lsp:syntax-highlighting",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" width="24" viewBox="0 0 24 24">\n  <g class="jp-icon3 jp-icon-selectable" fill="#616161" shape-rendering="geometricPrecision">\n    <path d="M10.48 10.88l3.68-3.68-3.68-3.68L11.6 2.4l4.8 4.8-4.8 4.8-1.12-1.12m-4.16 0L2.64 7.2l3.68-3.68L5.2 2.4.4 7.2 5.2 12l1.12-1.12zM8.5 23.8l2.337-2.338-.025-.017a1.283 1.283 0 010-1.802l4.029-4.029 3.604 3.604-4.029 4.03a1.267 1.267 0 01-1.776.017l-.536.535H8.5m10.124-11.976a1.283 1.283 0 011.802 0l1.81 1.802a1.293 1.293 0 010 1.81l-2.805 2.796-3.604-3.604 2.797-2.805z"/>\n  </g>\n</svg>\n'});const ln=o+":syntax_highlighting";class cn extends We{constructor(e){super(e),this.virtual_document.changed.connect(this.update_mode.bind(this),this),this.editors_with_active_highlight=new Set}get lab_integration(){return super.lab_integration}get settings(){return super.settings}get_mode(e){let t=this.lab_integration.mimeTypeService.getMimeTypeByLanguage({name:e});if(t&&"text/plain"!=t)return this.lab_integration.codeMirror.CodeMirror.findModeByMIME(t)}update_mode(){let e=this.virtual_document,t=new Set;for(let n of e.foreign_document_maps)for(let[e,i]of n.entries()){let n=i.editor,s=n.editor,o=s.getValue("\n").concat("").length,r=(n.getOffsetAt(e.end)-n.getOffsetAt(e.start))/o,a=i.virtual_document.language,l=this.get_mode(a);void 0!==l&&r>this.settings.composite.foreignCodeThreshold&&(t.add(n),s.getOption("mode")!=l.mime&&s.setOption("mode",l.mime))}if(t!=this.editors_with_active_highlight)for(let e of this.editors_with_active_highlight)t.has(e)||e.editor.setOption("mode",e.model.mimeType);this.editors_with_active_highlight=t}}class dn{constructor(e,t){this.mimeTypeService=e,this.codeMirror=t}}const hn={id:ln,requires:[r,an.IEditorServices,y.ISettingRegistry,rt.ICodeMirror,x.ITranslator],autoStart:!0,activate:(e,t,n,i,s,o)=>{const r=new He(i,ln),a=o.load("jupyterlab-lsp");t.register({feature:{editorIntegrationFactory:new Map([["CodeMirrorEditor",cn]]),commands:[],id:ln,name:a.__("Syntax highlighting"),labIntegration:new dn(n.mimeTypeService,s),settings:r}})}};var un=n(3290);class _n{constructor(e){this._sessionsChanged=new E.Signal(this),this._sessions=new Map,this._warningsEmitted=new Set,this._settings=e.settings||un.ServerConnection.makeSettings(),this._baseUrl=e.baseUrl||D.PageConfig.getBaseUrl(),this._retries=e.retries||2,this._retriesInterval=e.retriesInterval||1e4,this._statusCode=null,this._configuration={},this.console=e.console,this.fetchSessions().catch(console.warn)}get statusUrl(){return D.URLExt.join(this._baseUrl,i.URL_NS,"status")}get sessionsChanged(){return this._sessionsChanged}get sessions(){return this._sessions}setConfiguration(e){this._configuration=e}warnOnce(e){this._warningsEmitted.has(e)||(this._warningsEmitted.add(e),this.console.warn(e))}_comparePriorities(e,t){var n,i,s,o;const r=null!==(i=null===(n=this._configuration[e])||void 0===n?void 0:n.priority)&&void 0!==i?i:50,a=null!==(o=null===(s=this._configuration[t])||void 0===s?void 0:s.priority)&&void 0!==o?o:50;return r==a?(this.warnOnce(`Two matching servers: ${e} and ${t} have the same priority; choose which one to use by changing the priority in Advanced Settings Editor`),e.localeCompare(t)):a-r}getMatchingServers(e){if(!e.language)return this.console.error("Cannot match server by language: language not available; ensure that kernel and specs provide language and MIME type"),[];const t=[],n=e.language.toLocaleLowerCase();for(const[e,i]of this._sessions.entries())i.spec.languages.some((e=>e.toLocaleLowerCase()==n))&&t.push(e);return t.sort(this._comparePriorities.bind(this))}get statusCode(){return this._statusCode}async fetchSessions(){let e,t=await un.ServerConnection.makeRequest(this.statusUrl,{method:"GET"},this._settings);if(this._statusCode=t.status,!t.ok)return console.error("Could not fetch sessions",t),void(this._retries>0&&(this._retries-=1,setTimeout(this.fetchSessions.bind(this),this._retriesInterval)));try{e=(await t.json()).sessions}catch(e){return void console.warn(e)}for(let t of Object.keys(e)){let n=t;this._sessions.has(n)?Object.assign(this._sessions.get(n),e[t]):this._sessions.set(n,e[t])}const n=this._sessions.keys();for(const t in n)if(!e[t]){let e=t;this._sessions.delete(e)}this._sessionsChanged.emit(void 0)}}class gn{constructor(){this._overrides={}}get registry(){return this._overrides}register(e,t){t in this._overrides||(this._overrides[t]={cell:[],line:[]});let n=this._overrides[t];switch(e.scope){case"cell":n.cell.push(e);break;case"line":n.line.push(e)}}}const pn={id:p.name,requires:[],activate:e=>new gn,provides:p,autoStart:!0};let mn={python:[new g({language:"python",pattern:"^%%(python|python2|python3|pypy)( .*?)?\n([^]*)",foreign_capture_groups:[3],is_standalone:!0,file_extension:"py"}),new g({language:"perl",pattern:"^%%(perl)( .*?)?\n([^]*)",foreign_capture_groups:[3],is_standalone:!0,file_extension:"pl"}),new g({language:"ruby",pattern:"^%%(ruby)( .*?)?\n([^]*)",foreign_capture_groups:[3],is_standalone:!0,file_extension:"rb"}),new g({language:"sh",pattern:"^%%(sh|bash)( .*?)?\n([^]*)",foreign_capture_groups:[3],is_standalone:!0,file_extension:"sh"}),new g({language:"html",pattern:"^%%(html --isolated)( .*?)?\n([^]*)",foreign_capture_groups:[3],is_standalone:!0,file_extension:"html"}),new g({language:"javascript",pattern:"^%%(js|javascript)( .*?)?\n([^]*)",foreign_capture_groups:[3],is_standalone:!1,file_extension:"js"}),new g({language:"html",pattern:"^%%(?!html --isolated)(html)( .*?)?\n([^]*)",foreign_capture_groups:[3],is_standalone:!1,file_extension:"html"}),new g({language:"latex",pattern:"^%%(latex)( .*?)?\n([^]*)",foreign_capture_groups:[3],is_standalone:!1,file_extension:"tex"}),new g({language:"markdown",pattern:"^%%(markdown)( .*?)?\n([^]*)",foreign_capture_groups:[3],is_standalone:!1,file_extension:"md"})]};function fn(e){return e.replace(/\\"/g,'"')}function vn(e){return e?function(e){return e.replace(/"/g,'\\"')}(e):""}const wn="^(\\s*|\\s*\\S+\\s*=\\s*)";let yn=[{pattern:wn+"!([^=\\s]+)(.*)(\n)?",replacement:'$1get_ipython().getoutput("$2$3")$4',scope:"line",reverse:{pattern:'get_ipython\\(\\).getoutput\\("(.*?)"\\)(\n)?',replacement:"!$1$2",scope:"line"}},{pattern:"^(\\s*)(\\?{1,2})([^?\\s'\"\\(\\)-\\+\\/#]+)(\n)?$",replacement:(e,t,n,i,s)=>`${t}get_ipython().run_line_magic('${"?"==n?"pinfo":"pinfo2"}', '${i}')${s=s||""}`,scope:"line",reverse:{pattern:"get_ipython\\(\\).run_line_magic\\('(pinfo2?)', '(.*?)'\\)(\n)?",replacement:(e,t,n)=>`${"pinfo"==t?"?":"??"}${n}`,scope:"line"}},{pattern:"^(\\s*)([^?\\s'\"\\(\\)-\\+\\/#]+)(\\?{1,2})(\n)?",replacement:(e,t,n,i,s)=>`${t}get_ipython().run_line_magic('${"?"==i?"pinfo":"pinfo2"}',  '${n}')${s=s||""}`,scope:"line",reverse:{pattern:"get_ipython\\(\\).run_line_magic\\('(pinfo2?)',  '(.*?)'\\)(\n)?",replacement:(e,t,n)=>`${n}${"pinfo"==t?"?":"??"}`,scope:"line"}},{pattern:wn+"%(\\S+)(.*)(\n)?",replacement:(e,t,n,i,s)=>`${t}get_ipython().run_line_magic("${n}", "${i=vn(i)}")${s=s||""}`,scope:"line",reverse:{pattern:'get_ipython\\(\\).run_line_magic\\("(.*?)", "(.*?)"\\)(\n)?',replacement:(e,t,n)=>`%${t}${n=fn(n)}`,scope:"line"}},{pattern:"^%%(\\S+)(.*\n)([\\s\\S]*)",replacement:(e,t,n,i,s,o)=>((n=vn(n))&&(n=n.slice(0,-1)),`get_ipython().run_cell_magic("${t}", "${n}", """${i=i.replace(/"""/g,'\\"\\"\\"')}""")`),scope:"cell",reverse:{pattern:'^get_ipython\\(\\).run_cell_magic\\("(.*?)", "(.*?)", """([\\s\\S]*)"""\\)',replacement:(e,t,n,i)=>(i=i.replace(/\\"\\"\\"/g,'"""'),`%%${t}${n=fn(n)}\n${i}`),scope:"cell"}}];const bn={id:o+":ipython",requires:[c,p],activate:(e,t,n)=>{for(let e of Object.keys(mn))for(let n of mn[e])t.register(n,e);for(let e of yn)n.register(e,"python")},autoStart:!0},xn="(?:"+["-l","--connections"].join("|")+"|"+["--destination_table","--project","--use_bqstorage_api","--use_rest_api","--use_legacy_sql","--verbose","--params"].map((e=>e+" \\w+")).join("|")+")";let kn={python:[new g({language:"sql",pattern:`^%%bigquery(?: (?:(?:(?:.*?)://(?:.*))|${xn}|(?:\\w+ << )|(?:\\w+@\\w+)))?\n?((?:.+\n)?(?:[^]*))`,foreign_capture_groups:[1],is_standalone:!0,file_extension:"sql"})]};const Cn={id:o+":ipython-bigquery",requires:[c],activate:(e,t)=>{for(let e of Object.keys(kn))for(let n of kn[e])t.register(n,e)},autoStart:!0};function Sn(e,t){let n=[],i=[],s=[];for(let t=0;t<e.length;t+=2){let o=e[t],r=e[t+1];if(null==o)break;"i"===o||"-input"===o?n.push(r):"o"===o||"-output"===o?i.push(r):s.push("-"+o+" "+r)}return{inputs:n,outputs:i,rest:e[e.length+t],others:s}}function En(e,t){let{inputs:n,outputs:i,rest:s,others:o}=Sn(e,t),r=n.join(", ");r&&(r=", "+r);let a=i.join(", ");return a&&(a+=" = "),{content:s,others:o.join(" "),inputs:r,outputs:a}}function Mn(e='"',t=!1){return"(\\S+)?"+"(?:, (\\S+))?".repeat(9)+"( = )?rpy2\\.ipython\\.rmagic\\.RMagics.R\\("+e+(t?"([\\s\\S]*)":"(.*?)")+e+', "(.*?)"'+"(?:, (\\S+))?".repeat(10)+"\\)"}function jn(e,...t){let n=[];for(let e=0;e<10&&null!=t[e];e++)n.push(t[e]);let i=[];for(let e=13;e<23&&null!=t[e];e++)i.push(t[e]);let s=i.join(" -i ");s&&(s=" -i "+s);let o=n.join(" -o ");o&&(o=" -o "+o);let r=t[11],a=t[12];return a&&(a=" "+a),{input:s,output:o,other:a,contents:r}}function In(e){return"(?: -(\\S+) (\\S+))?".repeat(e)}function Tn(e){return function(t,...n){let i,s=Sn(n,-3);return i=null==s.rest?"":e&&s.rest.startsWith(" ")?s.rest.slice(1):s.rest,i}}let Ln=Tn(!1);function Rn(e,...t){let n=Sn(t,-3).inputs.map((e=>e+" <- data.frame();")).join(" "),i=Ln(e,...t);return""!==n&&i&&(n+=" "),n}let An={python:[new g({language:"r",pattern:"^%%R"+In(10)+"\n([^]*)",foreign_capture_groups:[21],foreign_replacer:Ln,extract_arguments:Rn,is_standalone:!1,file_extension:"R"}),new g({language:"r",pattern:"(?:^|\n)%R"+In(10)+" ?(.*)?\n?",foreign_capture_groups:[21],foreign_replacer:Tn(!0),extract_arguments:Rn,is_standalone:!1,file_extension:"R"})]},Pn=[{pattern:wn+"%R"+In(10)+"(.*)(\n)?",replacement:(e,t,...n)=>{let i=En(n,-4);return`${t}${i.outputs}rpy2.ipython.rmagic.RMagics.R("${i.content}", "${i.others}"${i.inputs})`},scope:"line",reverse:{pattern:Mn(),replacement:(e,...t)=>{let n=jn(e,...t);return"%R"+n.input+n.output+n.other+n.contents},scope:"line"}},{pattern:"^%%R"+In(10)+"(\n)?([\\s\\S]*)",replacement:(e,...t)=>{let n=En(t,-3);return`${n.outputs}rpy2.ipython.rmagic.RMagics.R("""${n.content}""", "${n.others}"${n.inputs})`},scope:"cell",reverse:{pattern:Mn('"""',!0),replacement:(e,...t)=>{let n=jn(e,...t);return"%%R"+n.input+n.output+n.other+"\n"+n.contents},scope:"cell"}}];const Dn={id:o+":ipython-rpy2",requires:[c,p],activate:(e,t,n)=>{for(let e of Object.keys(An))for(let n of An[e])t.register(n,e);for(let e of Pn)n.register(e,"python")},autoStart:!0},On="(?:"+["-l","--connections"].join("|")+"|"+["-x","--close","-c","--creator","-p","--persist","--append"].map((e=>e+" \\w+")).join("|")+")";let zn={python:[new g({language:"sql",pattern:`^%%sql(?: (?:(?:(?:.*?)://(?:.*))|${On}|(?:\\w+ << )|(?:\\w+@\\w+)))?\n?((?:.+\n)?(?:[^]*))`,foreign_capture_groups:[1],is_standalone:!0,file_extension:"sql"}),new g({language:"sql",pattern:`(?:^|\n)%sql (?:(?:(?:.*?)://(?:.*))|${On}|(.*))\n?`,foreign_capture_groups:[1],is_standalone:!1,file_extension:"sql"})]};const $n=[Dn,{id:o+":ipython-sql",requires:[c],activate:(e,t)=>{for(let e of Object.keys(zn))for(let n of zn[e])t.register(n,e)},autoStart:!0},Cn,bn];class Fn{constructor(e,t){this.virtual_editor=e,this.adapter=t}markText(e,t,n){let i=this.virtual_editor.virtual_document.get_editor_at_source_line(e),s=this.virtual_editor.ce_editor_to_cm_editor.get(i),o=this.virtual_editor;return s.getDoc().markText(o.transform_from_root_to_editor(e),o.transform_from_root_to_editor(t),n)}getCursor(e){let t=this.adapter.activeEditor;if(null==t)return;let n=t.editor.getDoc().getCursor(e);return this.virtual_editor.transform_from_editor_to_root(t,n)}}class qn{constructor(e){return this.editor_name="CodeMirrorEditor",this.isDisposed=!1,this._event_wrappers=new Map,this.adapter=e.adapter,this.virtual_document=e.virtual_document,this.console=this.adapter.console,this.change=new E.Signal(this),this.block_added_handlers=[],this.block_removed_handlers=[],this.editor_to_source_line=new Map,this.cm_editor_to_ce_editor=new Map,this.ce_editor_to_cm_editor=new Map,this._proxy=new Proxy(this,{get:function(e,t,n){return t in e?Reflect.get(e,t,n):void console.warn(`Unimplemented method ${t.toString()} for CodeMirrorVirtualEditor`)}}),this.virtual_document.update_manager.update_began.connect(this.onEditorsUpdated,this),this.virtual_document.update_manager.block_added.connect(this.save_block_position,this),this.virtual_document.update_manager.update_finished.connect((()=>{this.editor_to_source_line=this.editor_to_source_line_new}),this),this.set_event_handlers(),this._proxy}dispose(){if(!this.isDisposed){this.editor_to_source_line.clear(),this.cm_editor_to_ce_editor.clear(),this.ce_editor_to_cm_editor.clear(),this.off("change",this.emit_change);for(let[[e],t]of this._event_wrappers.entries())this.forEveryBlockEditor((n=>{n.off(e,t)}),!1);this._event_wrappers.clear(),this.disconnectBlockMonitoring(),this.virtual_document.dispose(),this.virtual_document=null,this.code_extractors=null,this.isDisposed=!0,this.forEveryBlockEditor=null,this._proxy=null}}get_cursor_position(){return this.getDoc().getCursor("end")}onEditorsUpdated(e,t){this.cm_editor_to_ce_editor.clear(),this.ce_editor_to_cm_editor.clear(),this.editor_to_source_line_new=new Map;for(let e of t){let t=e.ce_editor,n=t.editor;this.cm_editor_to_ce_editor.set(n,t),this.ce_editor_to_cm_editor.set(t,n)}}save_block_position(e,t){this.editor_to_source_line_new.set(t.block.ce_editor,t.virtual_document.last_source_line)}set_event_handlers(){this.on("change",this.emit_change.bind(this))}emit_change(e,t){this.change.emit(t)}window_coords_to_root_position(e){return this.coordsChar(e,"window")}get_token_at(e){let t=this.getTokenAt(e);return{value:t.string,offset:t.start,type:t.type}}get_cm_editor(e){return this.get_editor_at_root_line(e)}transform_virtual_to_editor(e){return this.virtual_document.transform_virtual_to_editor(e)}document_at_root_position(e){let t=e;return this.virtual_document.root.document_at_source_position(t)}root_position_to_virtual_position(e){let t=e;return this.virtual_document.root.virtual_position_at_document(t)}get_editor_at_root_position(e){return this.virtual_document.root.get_editor_at_source_line(e)}root_position_to_editor(e){return this.virtual_document.root.transform_source_to_editor(e)}on(e,t,...n){let i=(e,...n)=>{try{return t(this,...n)}catch(t){this.console.warn("CodeMirrorVirtualEditor handler (which should accept a CodeMirror Editor instance) failed",{error:t,instance:e,args:n,this:this})}};this._event_wrappers.set([e,t],i),this.forEveryBlockEditor((t=>{t.on(e,i)}),!0,(t=>{t.off(e,i)}))}off(e,t,...n){let i=this._event_wrappers.get([e,t]);this.forEveryBlockEditor((t=>{t.off(e,i)}))}find_ce_editor(e){return this.cm_editor_to_ce_editor.get(e)}transform_from_editor_to_root(e,t){if(!this.editor_to_source_line.has(e))return this.console.warn("Editor not found in editor_to_source_line map"),null;let n=this.editor_to_source_line.get(e);return Object.assign(Object.assign({},t),{line:t.line+n})}transform_from_root_to_editor(e){return this.virtual_document.transform_source_to_editor(e)}addKeyMap(e,t){}addLineClass(e,t,n){}addLineWidget(e,t,n){}addOverlay(e,t){for(let n of this.adapter.editors)n.editor.addOverlay(e,t)}addPanel(e,t){}charCoords(e,t){try{return this.get_editor_at_root_line(e).charCoords(e,t)}catch(e){return console.log(e),{bottom:0,left:0,right:0,top:0}}}coordsChar(e,t){for(let n of this.adapter.editors){let i=n.editor.coordsChar(e,t);if(1!==i.outside)return this.transform_from_editor_to_root(n,i)}}cursorCoords(e,t){return"boolean"!=typeof e?this.get_editor_at_root_line(e).cursorCoords(this.transform_from_root_to_editor(e)):{bottom:0,left:0,top:0}}get any_editor(){return this.adapter.editors[0].editor}defaultCharWidth(){return this.any_editor.defaultCharWidth()}defaultTextHeight(){return this.any_editor.defaultTextHeight()}endOperation(){for(let e of this.adapter.editors)e.editor.endOperation()}execCommand(e){for(let t of this.adapter.editors)t.editor.execCommand(e)}getDoc(){return new Fn(this,this.adapter)}get_editor_at_root_line(e){let t=this.virtual_document.root.get_editor_at_source_line(e);return this.ce_editor_to_cm_editor.get(t)}getTokenAt(e,t){if(void 0!==e)return this.get_editor_at_root_line(e).getTokenAt(this.transform_from_root_to_editor(e))}getTokenTypeAt(e){let t=this.virtual_document.get_editor_at_source_line(e);return this.ce_editor_to_cm_editor.get(t).getTokenTypeAt(this.transform_from_root_to_editor(e))}get_editor_value(e){return e.model.value.text}getWrapperElement(){return this.adapter.wrapper_element}heightAtLine(e,t,n){return 0}isReadOnly(){return!1}lineAtHeight(e,t){return 0}disconnectBlockMonitoring(){for(let e of this.block_added_handlers)this.adapter.editorAdded.disconnect(e);this.block_added_handlers=[];for(let e of this.block_removed_handlers)this.adapter.editorRemoved.disconnect(e);this.block_removed_handlers=[]}forEveryBlockEditor(e,t=!0,n=null){const i=new Set;for(let t of this.adapter.editors){let n=t.editor;i.add(n),e(n)}if(t){const t=(t,n)=>{let{editor:s}=n;if(null==s)return;let o=s.editor;i.has(o)||e(o)},s=(e,t)=>{let{editor:i}=t;if(null==i)return;let s=i.editor;n(s)};this.block_added_handlers.push(t),this.block_added_handlers.push(s),this.adapter.editorAdded.connect(t),this.adapter.editorRemoved.connect(s)}}find_editor(e){let t=this.cm_editor_to_ce_editor.get(e);return{index:this.adapter.get_editor_index(t),node:this.adapter.get_editor_wrapper(t)}}}const Hn={id:o+":CodeMirrorVirtualEditor",requires:[l],activate:(e,t)=>t.registerEditorType({implementation:qn,name:"CodeMirrorEditor",supports:rt.CodeMirrorEditor}),autoStart:!0};class Nn{constructor(){this.editorTypes=[]}registerEditorType(e){this.editorTypes.push(e)}findBestImplementation(e){for(let t of this.editorTypes)if(e.every((e=>e instanceof t.supports)))return t;return console.warn("Cold not find a VirtualEditor suitable for the provided set of editors:",e),null}}const Wn={id:o+":ILSPVirtualEditorManager",requires:[],activate:e=>new Nn,provides:l,autoStart:!0};var Vn=m.JupyterFrontEnd.IPaths;class Un{constructor(){this.features=[],this.command_managers=[],this.command_manager_registered=new E.Signal(this)}register(e){if(e.supersedes)for(let t of e.supersedes)this.features=this.features.filter((e=>e.id!=t));if(this.features.push(e.feature),e.feature.commands){for(let t of this.command_managers)t.add(e.feature.commands);this.command_manager_registered.connect(((t,n)=>{n.add(e.feature.commands)}))}}registerCommandManager(e){this.command_managers.push(e),this.command_manager_registered.emit(e)}}class Bn{constructor(e,t,n,i,s,r,a,l,c,d,h,u,_){this.app=e,this.setting_registry=t,this.palette=n,this.editor_type_manager=a,this.code_extractors_manager=l,this.code_overrides_manager=c,this.console=d,this.translator=h,this.user_console=u;const g=(h||x.nullTranslator).load("jupyterlab-lsp");this.language_server_manager=new _n({console:this.console.scope("LanguageServerManager")}),this.connection_manager=new z({language_server_manager:this.language_server_manager,console:this.console.scope("DocumentConnectionManager")});const p=new Ee({language_server_manager:this.language_server_manager,connection_manager:this.connection_manager,adapter_manager:r,translator_bundle:g});null!==_?_.registerStatusItem(o+":language-server-status",{item:p.createItem(),align:"left",rank:1,isActive:()=>r.isAnyActive()}):e.docRegistry.addWidgetExtension("Notebook",p),this.feature_manager=new Un,this.setting_registry.load(Zn.id).then((e=>{const t=e.composite,n=t.language_servers||{};this.connection_manager.initial_configurations=n,this.connection_manager.updateConfiguration(n),this.connection_manager.updateLogging(t.logAllCommunication,t.setTrace),e.changed.connect((()=>{this.updateOptions(e)}))})).catch((e=>{d.error(e.message)})),r.registerExtension(this)}registerAdapterType(e,t){let n=new le(Object.assign({adapter_manager:e,app:this.app,palette:this.palette,tracker:t.tracker,suffix:t.name,entry_point:t.entrypoint,console:this.console},t.context_menu));this.feature_manager.registerCommandManager(n)}get foreign_code_extractors(){return this.code_extractors_manager.registry}get code_overrides(){return this.code_overrides_manager.registry}updateOptions(e){const t=e.composite,n=t.language_servers||{};this.connection_manager.initial_configurations=n,this.connection_manager.updateConfiguration(n),this.connection_manager.updateServerConfigurations(n),this.connection_manager.updateLogging(t.logAllCommunication,t.setTrace)}}const Zn={id:o+":plugin",requires:[y.ISettingRegistry,f.ICommandPalette,v.IDocumentManager,Vn,a,l,c,p,d,x.ITranslator],optional:[w.ILoggerRegistry,b.IStatusBar],activate:(e,...t)=>new Bn(e,...t).feature_manager,provides:r,autoStart:!0},Kn=[mt,st,rn,Gt,tn,Ht,Pt,hn],Jn=[B,Le,L,ae,se,Wn,Hn,k.COMPLETION_THEME_MANAGER,S.plugin,C.plugin,pn,Zn,...$n,...Kn]},6988:(e,t,n)=>{"use strict";n.d(t,{_v:()=>a,EU:()=>l,nE:()=>c,Gl:()=>d,Ei:()=>h,lj:()=>g,HY:()=>m});var i=n(3886),s=n(8644),o=n.n(s);const r=/^file:\/\/([^\/]+|\/[a-zA-Z](?::|%3A))/;async function a(e){return new Promise((t=>{setTimeout((()=>{t()}),e)}))}function l(e,t=35,n=50,i=(e=>e)){return new Promise((async(s,o)=>{let r=0;for(;!0!==e();){if(r+=1,-1!==t&&r>t){o("Too many retrials");break}n=i(n),await a(n)}s(e)}))}function c(e,t){const n=e.key||null;let i=!1;switch(t){case"Shift":i=e.shiftKey||"Shift"==n;break;case"Alt":i=e.altKey||"Alt"==n;break;case"AltGraph":i="AltGraph"==n;break;case"Control":i=e.ctrlKey||"Control"==n;break;case"Meta":i=e.metaKey||"Meta"==n;break;case"Accel":i=e.metaKey||"Meta"==n||e.ctrlKey||"Control"==n}return void 0!==e.getModifierState?i||e.getModifierState(t):i}class d extends Map{constructor(e,t){super(t),this.default_factory=e}get(e){return this.get_or_create(e)}get_or_create(e,...t){if(this.has(e))return super.get(e);{let n=this.default_factory(e,...t);return this.set(e,n),n}}}function h(e,t){return u(e)&&u(t)&&(e=_(e),t=_(t)),e===t||decodeURI(e)===decodeURI(t)}function u(e){return e.match(r)}function _(e){return e.replace(r,(e=>e.replace("%3A",":").toLowerCase()))}function g(e,t){return null==(t=t||i.PageConfig.getOption("rootUri"))?null:e.startsWith(t)?decodeURI(e.replace(t,"")):null}const p=(e,t)=>{const n={};let i=n;return e.forEach(((n,s)=>{i[n]={},s===e.length-1?i[n]=t:i=i[n]})),n},m=e=>{const t=[];for(let n in e){const i=p(n.split("."),e[n]);t.push(i)}return o()({},...t)}}}]);